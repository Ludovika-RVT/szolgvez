<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVT UTILS V7.5 - Integrated System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* FONT & BASIC SETUP */
        body { background-color: #f4f6f9; font-family: 'Verdana', sans-serif; font-size: 0.85rem; }
        
        /* HEADER DESIGN (Blue Theme) */
        .header-bg { 
            background-color: #0d47a1; 
            color: white; 
            padding: 10px 0; 
            border-bottom: 4px solid #42a5f5; 
        }
        
        /* MENU STYLES */
        .main-menu-container {
            max-width: 600px;
            margin: 50px auto;
        }
        .menu-btn-lg {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border-radius: 10px;
        }
        .menu-btn-lg:hover { transform: translateY(-3px); }
        .menu-btn-primary { background: linear-gradient(45deg, #0d47a1, #42a5f5); color: white; border: none; }
        .menu-btn-secondary { background: #e9ecef; color: #6c757d; border: 1px solid #ced4da; }
        .menu-btn-active-sub { background: linear-gradient(45deg, #d32f2f, #ef5350); color: white; border: none; } 
        .menu-btn-warning { background: linear-gradient(45deg, #f0932b, #ffbe76); color: white; border: none; font-size: 1rem; padding: 15px; }

        /* ICON LOGO STYLE */
        .gun-icon { margin-right: 10px; vertical-align: middle; color: #fff; }
        .gun-icon-login { color: #0d47a1; margin-bottom: 15px; }

        /* ACTIVE USERS DISPLAY */
        .online-list { font-size: 0.75rem; color: #bbdefb; margin-top: 2px; }
        .online-dot { color: #00e676; font-size: 8px; vertical-align: middle; margin-right: 2px; }

        /* TABLE STYLES (ROSTER) */
        .roster-table th, .roster-table td { 
            text-align: center; vertical-align: middle; padding: 4px 2px;
            white-space: nowrap; border: 1px solid #dee2e6; position: relative;
        }
        .roster-table th { background-color: #343a40; color: white; font-size: 0.75rem; }
        
        .clickable-header { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .clickable-header:hover { color: #ffc107; }

        .roster-cell { cursor: pointer; height: 35px; min-width: 45px; font-size: 0.75rem; }
        .roster-cell:hover { border: 2px solid #0d6efd; z-index: 10; }

        /* Note Indicator (Red triangle in corner) */
        .note-indicator {
            position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-top: 6px solid #dc3545;
        }

        /* HEADER COLORS */
        .th-sat { background-color: #d1e7dd !important; color: #0f5132 !important; } 
        .th-sun { background-color: #f8d7da !important; color: #842029 !important; } 
        .th-hol { background-color: #dc3545 !important; color: white !important; border-color: #b02a37; } 

        /* ENTRY COLORS */
        .cell-pn, .cell-pi { background-color: #e2e3e5; color: #6c757d; }
        .cell-x { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .cell-rsz { background-color: #e0cffc; color: #4a148c; font-weight: bold; } 
        .cell-b { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        .cell-tm { background-color: #d1e7dd; color: #0f5132; font-weight: bold; }
        
        /* Hour Summary Colors */
        .hour-under { background-color: #fff3cd; color: #856404; font-weight: bold; } 
        .hour-ok { background-color: #d1e7dd; color: #0f5132; font-weight: bold; } 
        .hour-over { background-color: #f8d7da; color: #842029; font-weight: bold; } 

        /* SPORT TEXT COLOR */
        .text-sport { color: #6610f2; font-weight: bold; font-size: 0.8em; display: block; margin-top: 2px; }

        .name-col { 
            text-align: left !important; padding-left: 8px !important; font-weight: bold; 
            position: sticky; left: 0; background: white; z-index: 5; min-width: 150px; 
            border-right: 2px solid #ccc; cursor: pointer; color: #0d6efd;
        }
        .name-col:hover { text-decoration: underline; background-color: #f8f9fa; }

        /* TASK MANAGER STYLES - UPDATED FOR PRIORITY */
        .task-card { margin-bottom: 10px; transition: all 0.2s; border-left-width: 6px; border-left-style: solid; }
        .task-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .task-priority-RED { border-left-color: #dc3545; } /* Azonnalos */
        .task-priority-YELLOW { border-left-color: #ffc107; } /* Soron kívül */
        .task-priority-BLUE { border-left-color: #0d6efd; } /* Általános */
        
        .task-done { border-left-color: #198754 !important; opacity: 0.7; background-color: #d1e7dd; } /* Kész - Zöld */
        .task-done .task-title { text-decoration: line-through; }
        .task-badge { font-size: 0.7em; padding: 4px 8px; border-radius: 12px; }

        /* LOGIN SCREEN & OVERLAYS */
        #loginOverlay, #loadingOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(13, 71, 161, 0.98); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            flex-direction: column; color: white;
        }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: #333; }
        
        /* CLOUD STATUS */
        .cloud-status { position: fixed; top: 10px; right: 10px; z-index: 10001; font-size: 12px; color: #ccc; }
        .cloud-ok { color: #2ecc71; }
        .cloud-sync { color: #f1c40f; }
        .cloud-error { color: #e74c3c; }

        /* HISTORY LOG */
        .log-entry { font-size: 0.8rem; border-bottom: 1px solid #eee; padding: 8px 0; }
        .log-time { color: #888; font-size: 0.75rem; }
        .log-user { font-weight: bold; color: #0d47a1; }
        .log-diff { font-family: monospace; color: #d63384; display: block; background: #f8f9fa; padding: 2px 5px; border-radius: 4px; margin-top: 2px; }

        /* PRINT SETTINGS (A3 Landscape - Scaled Down) */
        #printHeader, #printFooter { display: none; }
        .print-hidden-row { display: none !important; } 
        .hidden-perm { display: none !important; }

        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                zoom: 65%; /* SKÁLÁZÁS A LAPHOZ */
                font-family: 'Verdana', sans-serif; 
            }
            #mainApp > .header-bg, #mainMenu, #taskApp, #loginOverlay, #loadingOverlay, .cloud-status, .no-print, .nav-tabs, #alertPlace, .modal { display: none !important; }
            .tab-content > .tab-pane { display: none !important; }
            /* Force roster to show if printing roster */
            #mainApp { display: block !important; }
            #tab-roster { display: block !important; }
            
            #printHeader { display: block; margin-bottom: 20px; text-align: center; }
            #printHeader h2 { font-size: 28px; font-weight: bold; margin: 0; text-transform: uppercase; }
            #printHeader h3 { font-size: 20px; margin: 5px 0 0 0; font-weight: normal; }
            
            #printFooter { 
                display: flex !important; 
                justify-content: space-between; 
                align-items: flex-end;
                margin-top: 40px; 
                padding: 0 50px;
                font-size: 14px;
            }
            
            .card { border: none !important; box-shadow: none !important; }
            .roster-table { width: 100%; border-collapse: collapse; }
            .roster-table th, .roster-table td { border: 1px solid #000 !important; font-size: 10px !important; padding: 1px !important; height: 20px !important; }
            .name-col { min-width: 100px !important; color: black !important; text-decoration: none !important; }
            .th-sat, .th-sun, .th-hol, .cell-x, .cell-b, .cell-tm, .cell-rsz { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .note-indicator { display: none; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-light mb-3" role="status"></div>
        <h4>RVT UTILS rendszer betöltése...</h4>
        <small class="text-white-50" id="loadingStatusText">Kapcsolódás a Firebase-hez...</small>
    </div>

    <div class="cloud-status" id="cloudStatusIcon" title="Adatbázis Státusz">
        <i class="fa-solid fa-circle"></i> <span id="cloudStatusText">Offline</span>
    </div>

    <input type="file" id="jsonImportInput" accept=".json" style="display:none" onchange="processBackupImport(this)">

    <div id="loginOverlay" style="display:none;">
        <div class="login-box">
            <i class="fa-solid fa-gun fa-4x gun-icon-login"></i>
            <h3 class="mb-4 text-primary fw-bold" style="font-family: 'Verdana', sans-serif;">RVT UTILS</h3>
            
            <input type="text" class="form-control mb-2" id="loginUser" placeholder="Felhasználónév">
            <input type="password" class="form-control mb-3" id="loginPass" placeholder="Jelszó">
            <button class="btn btn-primary w-100 fw-bold" onclick="performLogin()">Belépés</button>
            <div class="mt-3 small text-muted">V7.5 - Integrated System</div>
        </div>
    </div>

    <div id="mainMenu" style="display:none;" class="container main-menu-container">
        <div class="text-center mb-4">
            <i class="fa-solid fa-layer-group fa-3x text-primary mb-2"></i>
            <h2 class="fw-bold text-dark">RVT UTILS</h2>
            <p class="text-muted" id="menuWelcomeText">Üdvözöllek!</p>
        </div>

        <div class="d-grid gap-3">
            <button class="btn menu-btn-lg menu-btn-primary" onclick="openModule('roster')">
                <i class="fa-solid fa-calendar-days me-2"></i> Szolgálattervezet Modul
            </button>
            
            <button class="btn menu-btn-lg menu-btn-active-sub" onclick="openModule('tasks')">
                <i class="fa-solid fa-list-check me-2"></i> Feladatkezelő & Elosztó
            </button>
            
            <button class="btn menu-btn-lg menu-btn-warning text-dark fw-bold" onclick="openChangePassModal()">
                <i class="fa-solid fa-key me-2"></i> Jelszó Módosítás
            </button>
            
            <button class="btn btn-link text-danger mt-3" onclick="performLogout()"><i class="fa-solid fa-power-off"></i> Kijelentkezés</button>
        </div>
    </div>

    <div id="taskApp" style="display:none;">
        <div class="header-bg no-print" style="background-color: #d32f2f; border-color: #ef5350;">
            <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-light me-3" onclick="openModule('menu')"><i class="fa-solid fa-arrow-left"></i> Menü</button>
                    <h4 class="m-0 fw-bold"><i class="fa-solid fa-list-check"></i> Feladatkezelő</h4>
                </div>
                <div class="text-end">
                    <span class="fw-bold d-block" id="taskUserInfo"></span>
                </div>
            </div>
        </div>

        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-secondary">Aktív Feladatok</h5>
                <button class="btn btn-danger fw-bold admin-only" onclick="openAddTaskModal()"><i class="fa-solid fa-plus"></i> Új Feladat Kiírása</button>
            </div>

            <div id="activeTasksList" class="mb-5">
                <div class="text-center text-muted p-4">Nincs aktív feladat.</div>
            </div>

            <h5 class="fw-bold text-secondary border-top pt-3">Elvégzett / Lezárt Feladatok</h5>
            <div id="completedTasksList" class="opacity-75">
                </div>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="header-bg no-print">
            <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-light me-3" onclick="openModule('menu')"><i class="fa-solid fa-arrow-left"></i> Menü</button>
                    <i class="fa-solid fa-gun fa-2x gun-icon"></i>
                    <h4 class="m-0 fw-bold">RVT Szolgálattervezet</h4>
                    
                    <div class="d-flex align-items-center gap-2 ms-4">
                        <select id="selYear" class="form-select form-select-sm w-auto" onchange="changePeriod()"></select>
                        <select id="selMonth" class="form-select form-select-sm w-auto" onchange="changePeriod()">
                            <option value="0">Január</option><option value="1">Február</option><option value="2">Március</option>
                            <option value="3">Április</option><option value="4">Május</option><option value="5">Június</option>
                            <option value="6">Július</option><option value="7">Augusztus</option><option value="8">Szeptember</option>
                            <option value="9">Október</option><option value="10">November</option><option value="11">December</option>
                        </select>
                    </div>
                </div>
                <div class="text-end">
                    <span class="fw-bold d-block" id="userInfo"></span>
                    <div class="online-list" id="activeUsersList"><i class="fa-solid fa-spinner fa-spin"></i></div>
                </div>
            </div>
        </div>

        <div class="container-fluid mt-3">
            <div id="alertPlace"></div>

            <ul class="nav nav-tabs mb-3 no-print" id="mainTab" role="tablist">
                <li class="nav-item"><button class="nav-link active fw-bold" data-bs-target="#tab-roster" data-bs-toggle="tab"><i class="fa-solid fa-table"></i> Vezénylés (Naptár)</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-primary fw-bold" data-bs-target="#tab-batch" data-bs-toggle="tab"><i class="fa-solid fa-layer-group"></i> Csoportos Rögzítés</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-danger fw-bold" data-bs-target="#tab-users" data-bs-toggle="tab"><i class="fa-solid fa-user-lock"></i> Jogosultságok & Szabadság</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-secondary fw-bold" data-bs-target="#tab-settings" data-bs-toggle="tab"><i class="fa-solid fa-calendar-check"></i> Havi Beállítások</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-info fw-bold" data-bs-target="#tab-history" data-bs-toggle="tab"><i class="fa-solid fa-clock-rotate-left"></i> Történet</button></li>
            </ul>

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-roster">
                    <div id="printHeader">
                        <h2>RVT SZOLGÁLATVEZÉNYLÉS</h2>
                        <h3 id="printSubtitle"></h3>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2 no-print">
                        <div class="text-muted small align-self-end"><i class="fa-solid fa-info-circle"></i> A nevekre kattintva megnyitható a felhasználói profil.</div>
                        
                        <div class="btn-group">
                             <button class="btn btn-outline-danger btn-sm fw-bold me-2" onclick="openAbsenceStats()"><i class="fa-solid fa-list-check"></i> Havi Távollét & Sport</button>
                             <button class="btn btn-outline-success btn-sm fw-bold admin-only" onclick="exportBackup()"><i class="fa-solid fa-download"></i> Mentés (Backup)</button>
                             <button class="btn btn-outline-warning btn-sm fw-bold admin-only" onclick="document.getElementById('jsonImportInput').click()"><i class="fa-solid fa-upload"></i> Visszatöltés</button>
                             <button class="btn btn-dark btn-sm ms-2" onclick="openPrintModal()"><i class="fa-solid fa-print"></i> Nyomtatás...</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm roster-table mb-0" id="mainRosterTable">
                                    <thead id="rosterHead"></thead>
                                    <tbody id="rosterBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 small text-muted">
                        Jelmagyarázat: <b>PI</b>: Pihenőidő | <b>PN</b>: Pihenőnap | <b>X</b>: Szabadság | <b>RSZ</b>: Rendkívüli Szab. | <b>B</b>: Beteg | <b>TM</b>: Túlszolg. Megváltás
                    </div>

                    <div id="printFooter">
                        <div style="text-align:left;">
                            Budapest, <span id="printDate"></span>
                        </div>
                        <div style="text-align:center; padding-bottom: 40px; font-weight: bold;">
                            Jóváhagyom:
                        </div>
                        <div style="text-align:center; width: 350px;">
                            <div style="border-bottom: 2px solid black; margin-bottom: 8px;">&nbsp;</div>
                            <strong style="font-size: 1.1em;">Dr. Fekete Csaba r. dandártábornok</strong><br>
                            rendőrségi főtanácsos, mesteroktató<br>
                            intézetvezető, tagozatparancsnok
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-batch">
                     <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white fw-bold">Csoportos / Több napos rögzítés</div>
                                <div class="card-body">
                                    <label class="form-label fw-bold">1. Kinek?</label>
                                    <select class="form-select mb-3" id="batchUserSelect"></select>
                                    
                                    <label class="form-label fw-bold">2. Mettől - Meddig?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-6"><input type="number" class="form-control" id="batchStartDay" placeholder="Kezdő nap (pl. 1)" min="1" max="31"></div>
                                        <div class="col-6"><input type="number" class="form-control" id="batchEndDay" placeholder="Vég nap (pl. 5)" min="1" max="31"></div>
                                    </div>

                                    <label class="form-label fw-bold">3. Mit?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <select class="form-select" id="batchType" onchange="toggleBatchTime()">
                                                <option value="WORK">Szolgálat</option>
                                                <option value="X">Szabadság (X)</option>
                                                <option value="RSZ">Rendkívüli Szab. (RSZ)</option>
                                                <option value="B">Beteg (B)</option>
                                                <option value="PI">Pihenőidő (PI)</option>
                                                <option value="PN">Pihenőnap (PN)</option>
                                                <option value="TM">Megváltás (TM)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8" id="batchTimeInputs">
                                            <div class="input-group">
                                                <span class="input-group-text">Idő</span>
                                                <input type="time" class="form-control" id="batchStartTime" value="07:00">
                                                <span class="input-group-text">-</span>
                                                <input type="time" class="form-control" id="batchEndTime" value="15:30">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100 fw-bold" onclick="applyBatch()">RÖGZÍTÉS VÉGREHAJTÁSA</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-users">
                     <div class="card border-danger">
                        <div class="card-header bg-danger text-white fw-bold d-flex justify-content-between">
                            <span>Felhasználók & Szabadság Keret</span>
                            <span class="badge bg-white text-danger" id="currentAdminYearDisplay"></span>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-4 align-items-end border-bottom pb-4">
                                <div class="col-md-3">
                                    <label class="small text-muted">Teljes Név</label>
                                    <input type="text" class="form-control" id="newUserName" placeholder="pl. Minta János">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Login Név</label>
                                    <input type="text" class="form-control" id="newUserLogin" placeholder="pl. janos">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Jelszó</label>
                                    <input type="text" class="form-control" id="newUserPass" placeholder="******">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Jogosultság</label>
                                    <select class="form-select" id="newUserRole">
                                        <option value="USER">User</option>
                                        <option value="VIEWER">Betekintő</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Keret (Idei + Tavalyi)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="newUserQuota" value="20" placeholder="Idén">
                                        <input type="number" class="form-control" id="newUserCarried" value="0" placeholder="Tavaly">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-success w-100" onclick="addNewUser()" title="Új felhasználó"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>

                            <div class="alert alert-secondary d-flex align-items-center justify-content-between py-2">
                                <div><i class="fa-solid fa-users-gear"></i> <b>Csoportos Beállítás:</b> Minden felhasználó éves szabadság keretének beállítása:</div>
                                <div class="input-group w-auto">
                                    <input type="number" class="form-control form-control-sm" id="batchQuotaInput" value="25" style="width: 70px;">
                                    <button class="btn btn-sm btn-dark" onclick="setAllUserQuota()">Mindenkinek Beállít</button>
                                </div>
                            </div>
                            
                            <h5 class="mb-3">Regisztrált Felhasználók</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Név</th>
                                            <th>Login</th>
                                            <th style="width: 150px;">Jelszó (Rejtett)</th>
                                            <th>Jogkör</th>
                                            <th>Szabadság (Idei + Tavalyi / Kivett)</th>
                                            <th>Művelet</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userSettingsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-settings">
                     <div class="card h-100 border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">Havi Beállítások (Norma & Ünnepek)</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Havi Norma (Óra) - Auto számolt:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="configNorma">
                                            <button class="btn btn-outline-secondary" onclick="calculateNormaForUI()" title="Újraszámolás"><i class="fa-solid fa-rotate-right"></i></button>
                                        </div>
                                        <small class="text-muted">Számítás: (Napok - Hétvége - Ünnep + Ledolgozós) * 8.</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-danger">Ünnepnapok (Piros):</label>
                                        <input type="text" class="form-control" id="configHolidays" placeholder="pl. 1, 15, 23" onchange="calculateNormaForUI()">
                                        <small class="text-muted">Vesszővel elválasztva.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-success">Ledolgozós Hétvégék / Áthelyezés:</label>
                                        <input type="text" class="form-control" id="configWorkWeekends" placeholder="pl. 13=24 (13 dolgozós, 24 pihenő), 7 (sima túlóra)" onchange="calculateNormaForUI()">
                                        <small class="text-muted">Formátum: <b>X=Y</b> (X munkanap Y helyett) vagy csak <b>X</b> (extra munkanap).</small>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning w-100 fw-bold" onclick="saveMonthConfig()">Beállítások Mentése</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="tab-history">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center">
                            <span>Módosítási Történet (Log)</span>
                            <div class="btn-group admin-only">
                                <button class="btn btn-sm btn-light text-dark fw-bold" onclick="exportHistoryCSV()"><i class="fa-solid fa-file-csv"></i> Exportálás CSV-be</button>
                                <button class="btn btn-sm btn-danger fw-bold" onclick="clearHistory()"><i class="fa-solid fa-trash"></i> Történet Törlése</button>
                            </div>
                        </div>
                        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                            <div id="historyLogList">
                                <p class="text-muted text-center">Nincs megjeleníthető adat.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ... Modals ... -->
    <div class="modal fade" id="changePassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Jelszó Módosítás</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Régi Jelszó:</label>
                        <input type="password" class="form-control" id="cpOldPass">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Új Jelszó:</label>
                        <input type="password" class="form-control" id="cpNewPass">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Új Jelszó Megerősítése:</label>
                        <input type="password" class="form-control" id="cpNewPass2">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary fw-bold" onclick="saveNewPassword()">Mentés</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-plus"></i> Új Feladat Kiírása</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Feladat Megnevezése:</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Rövid cím...">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Kategória / Prioritás:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="taskPrio" id="prioRed" value="RED" autocomplete="off">
                            <label class="btn btn-outline-danger" for="prioRed">Azonnalos (Piros)</label>

                            <input type="radio" class="btn-check" name="taskPrio" id="prioYellow" value="YELLOW" autocomplete="off">
                            <label class="btn btn-outline-warning text-dark" for="prioYellow">Soron kívül (Sárga)</label>

                            <input type="radio" class="btn-check" name="taskPrio" id="prioBlue" value="BLUE" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="prioBlue">Általános (Kék)</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Leírás / Email szöveg:</label>
                        <textarea class="form-control" id="taskDesc" rows="4" placeholder="Részletes leírás..."></textarea>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">Határidő Dátum:</label>
                            <input type="date" class="form-control" id="taskDeadlineDate">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Időpont:</label>
                            <input type="time" class="form-control" id="taskDeadlineTime" value="12:00">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Felelősök (Több is jelölhető):</label>
                        <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;" id="taskMultiSelectDiv">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="saveNewTask()">Kiosztás</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="completeTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Feladat Elvégzése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="completeTaskId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Elvégzés módja / Megjegyzés:</label>
                        <textarea class="form-control" id="completionNote" rows="3" placeholder="Ide írd le, hogyan oldottad meg, vagy mi lett az eredmény..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Mégse</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="finishTask()">Mentés & Kész</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="editModalTitle">Napi Beosztás Szerkesztése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId"><input type="hidden" id="editDay">
                    
                    <div id="userRestrictMsg" class="alert alert-warning small py-1 mb-2" style="display:none;">
                         <i class="fa-solid fa-lock"></i> Felhasználóként csak a megjegyzést szerkesztheted.
                    </div>

                    <div id="editModalContent">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Státusz:</label>
                            <div class="row g-1">
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stWork" value="WORK" checked onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stWork">Szolgálat</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPI" value="PI" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stPI">Pihenőidő</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPN" value="PN" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stPN">Pihenőnap</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stX" value="X" onchange="toggleModalFields()"><label class="btn btn-outline-warning text-dark w-100 btn-sm" for="stX">Szabadság</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stRSZ" value="RSZ" onchange="toggleModalFields()"><label class="btn btn-outline-dark w-100 btn-sm" style="background-color:#e0cffc; border-color:#9575cd;" for="stRSZ">Rendkívüli</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stB" value="B" onchange="toggleModalFields()"><label class="btn btn-outline-danger w-100 btn-sm" for="stB">Beteg</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stTM" value="TM" onchange="toggleModalFields()"><label class="btn btn-outline-success w-100 btn-sm" for="stTM">TM</label></div>
                            </div>
                        </div>

                        <div id="timeFields">
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label>Kezdés:</label><input type="time" class="form-control" id="startTime" onchange="calcHours()"></div>
                                <div class="col-6"><label>Vége:</label><input type="time" class="form-control" id="endTime" onchange="calcHours()"></div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label>Számolt Óra:</label><input type="number" class="form-control" id="calcHours" step="0.5"></div>
                            <div class="col-6"><label class="text-primary">Túlszolgálat (+):</label><input type="number" class="form-control border-primary" id="overtimeVal" step="0.5"></div>
                        </div>

                        <div class="mb-3 bg-light p-2 border rounded">
                            <label class="form-label fw-bold text-primary"><i class="fa-solid fa-dumbbell"></i> Sportfoglalkozás (perc):</label>
                            <input type="number" class="form-control" id="sportTime" placeholder="Pl. 60" min="0">
                            <small class="text-muted d-block mt-1">Heti limit: 120 perc.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label text-muted small">Megjegyzés / Indoklás:</label>
                            <textarea class="form-control" id="dayNote" rows="2" placeholder="Pl. túlszolgálat oka, vagy rendkívüli szabadság indoka..."></textarea>
                        </div>
                    </div>

                    <div id="editButtons">
                        <button class="btn btn-success w-100 fw-bold" onclick="saveEntry()">MENTÉS</button>
                        <button class="btn btn-outline-danger w-100 mt-2" onclick="deleteEntry()">Törlés</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals: Batch, Print, Profile, AbsenceStats -->
    <div class="modal fade" id="colBatchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Napi Csoportos Rögzítés (<span id="colBatchDayDisplay"></span>)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="colBatchDay">
                    <p class="small text-muted">Ez a beállítás <b>MINDENKIRE</b> érvényes lesz ezen a napon!</p>
                    <label class="fw-bold mb-2">Mit rögzítsünk mindenkinek?</label>
                    <div class="row g-2 mb-3">
                        <div class="col-md-5">
                            <select class="form-select" id="colBatchType" onchange="toggleColBatchTime()">
                                <option value="WORK">Szolgálat</option>
                                <option value="X">Szabadság</option>
                                <option value="RSZ">Rendkívüli Szab.</option>
                                <option value="PN">Pihenőnap</option>
                                <option value="PI">Pihenőidő</option>
                                <option value="TM">Megváltás</option>
                            </select>
                        </div>
                        <div class="col-md-7" id="colBatchTimeDiv">
                             <div class="input-group">
                                <input type="time" class="form-control" id="colBatchStart" value="07:00">
                                <span class="input-group-text">-</span>
                                <input type="time" class="form-control" id="colBatchEnd" value="15:30">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveColBatch()">MINDENKI FRISSÍTÉSE</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="printModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Nyomtatás kiválasztása</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Kik szerepeljenek a nyomtatáson?</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllPrint(true)">Összes</button>
                    </div>
                    <div class="list-group" id="printUserList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="executePrint()">NYOMTATÁS (A3 Fekvő)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-user"></i> Felhasználói Profil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="profileUserId">
                    <h4 id="profileName" class="mb-1 fw-bold text-center text-primary"></h4>
                    <p id="profileLogin" class="text-center text-muted small mb-4"></p>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body">
                            <h6 class="fw-bold">Éves Szabadság Statisztika (<span id="profileYear"></span>)</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Felhasznált / Keret (Idei+Tavalyi):</span>
                                <span class="fs-5 fw-bold" id="profileLeaveStats"></span>
                            </div>
                            <div class="text-center small text-muted mb-2" id="profileLeaveBreakdown"></div>
                            
                            <div class="progress mt-2" style="height: 10px;">
                                <div class="progress-bar bg-warning" id="profileLeaveProgress" style="width: 0%"></div>
                            </div>
                            <small id="leaveWarning" class="text-danger fw-bold mt-1 d-block" style="display:none;"></small>
                        </div>
                    </div>

                    <div id="adminProfilePanel" style="display:none;" class="mb-3 border-top pt-3">
                        <h6 class="fw-bold text-danger"><i class="fa-solid fa-gear"></i> Admin Beállítások</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">Idei Keret:</label>
                                <input type="number" id="profileQuotaInput" class="form-control border-danger" placeholder="Pl. 25">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Tavalyról Áthozott:</label>
                                <input type="number" id="profileCarriedInput" class="form-control border-danger" placeholder="Pl. 5">
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="fw-bold mb-3">Jelszó Módosítás</h6>
                    <div id="oldPassDiv" class="mb-2">
                        <label class="small">Régi Jelszó</label>
                        <input type="password" id="profileOldPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="small">Új Jelszó</label>
                        <input type="password" id="profileNewPass" class="form-control">
                    </div>
                    
                    <div id="adminOverrideDiv" class="alert alert-warning small py-1" style="display:none;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Admin módban a régi jelszó nem szükséges.
                    </div>

                    <button class="btn btn-info text-white w-100 fw-bold" onclick="saveProfileChanges()">Változtatások Mentése</button>
                    <div class="text-center mt-2">
                        <small class="text-muted" id="profileMessage"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="absenceStatsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-list-check"></i> Havi Távollét & Sport Statisztika</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-center fw-bold mb-3" id="absenceStatsTitle"></h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-start">Név</th>
                                    <th>Szabadság (X)</th>
                                    <th>Beteg (B)</th>
                                    <th>Rendkívüli (RSZ)</th>
                                    <th>TM</th>
                                    <th style="min-width: 250px;">Sport (Havi / Heti)</th>
                                    <th>Összesen Távollét</th>
                                </tr>
                            </thead>
                            <tbody id="absenceStatsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (Felhasználó által megadott)
        const firebaseConfig = {
            apiKey: "AIzaSyC25gpixaqD9eFf_y5ANXpaPQBjovS1MM8",
            authDomain: "szolgvez-46865.firebaseapp.com",
            projectId: "szolgvez-46865",
            storageBucket: "szolgvez-46865.firebasestorage.app",
            messagingSenderId: "559975823630",
            appId: "1:559975823630:web:a07f4bce53279e3f75bf5f"
        };

        let app, fsDB;
        let dataReady = false;

        try {
            app = initializeApp(firebaseConfig);
            fsDB = getFirestore(app);
            console.log("Firebase Connected");
        } catch(e) {
            console.error("Firebase Connect Error:", e);
            document.getElementById("loadingStatusText").innerText = "Hiba: " + e.message;
        }

        // INIT SYNC
        function initFirebaseSync() {
            if(!fsDB) return;
            const statusIcon = document.getElementById("cloudStatusIcon");
            const statusText = document.getElementById("cloudStatusText");

            statusIcon.className = "cloud-status cloud-sync";
            statusText.innerText = "Sync...";

            // 1. USERS
            onSnapshot(doc(fsDB, "rvt_data", "users"), (snap) => {
                if(snap.exists()) {
                    window.users = snap.data().list || [];
                    checkReady();
                } else {
                    initializeDefaultDB();
                }
            });

            // 2. ROSTER (db)
            onSnapshot(doc(fsDB, "rvt_data", "roster"), (snap) => {
                if(snap.exists()) {
                    window.db = snap.data().data || {};
                    checkReady();
                }
            });

            // 3. CONFIGS
            onSnapshot(doc(fsDB, "rvt_data", "configs"), (snap) => {
                if(snap.exists()) {
                    window.configs = snap.data().data || {};
                    checkReady();
                }
            });

            // 4. PRESENCE
            onSnapshot(doc(fsDB, "rvt_data", "presence"), (snap) => {
                if(snap.exists()) {
                    renderPresence(snap.data());
                }
            });
            
            // 5. TASKS
            onSnapshot(doc(fsDB, "rvt_data", "tasks"), (snap) => {
                if(snap.exists()) {
                    window.tasks = snap.data().list || [];
                    if(document.getElementById("taskApp").style.display === "block") {
                        window.renderTasks();
                    }
                }
            });

            // 6. HISTORY LOG (ÚJ)
            onSnapshot(doc(fsDB, "rvt_data", "history"), (snap) => {
                if(snap.exists()) {
                    window.logs = snap.data().list || [];
                    if(document.getElementById("tab-history").classList.contains("active")) {
                        window.renderHistory();
                    }
                }
            });

            function checkReady() {
                if(!dataReady) {
                    document.getElementById("loadingOverlay").style.display = "none";
                    document.getElementById("loginOverlay").style.display = "flex";
                    dataReady = true;
                }
                statusIcon.className = "cloud-status cloud-ok";
                statusText.innerText = "Online";

                if(window.currentUser) {
                    const liveUser = window.users.find(u => u.id === window.currentUser.id);
                    if(liveUser) window.currentUser = liveUser;
                    // Refresh current view logic
                    if(document.getElementById("mainApp").style.display === "block") {
                        window.changePeriod();
                        window.renderSettings();
                        window.renderBatchSelect();
                        if(window.currentUser.role === 'ADMIN') window.renderHistory();
                    }
                    if(document.getElementById("taskApp").style.display === "block") {
                         window.renderTasks();
                    }
                }
            }
        }

        // SAVE FUNCTIONS
        window.pushData = async function() {
            if(!fsDB) return;
            document.getElementById("cloudStatusText").innerText = "Mentés...";
            try {
                await setDoc(doc(fsDB, "rvt_data", "users"), { list: window.users }, { merge: true });
                await setDoc(doc(fsDB, "rvt_data", "roster"), { data: window.db }, { merge: true });
                await setDoc(doc(fsDB, "rvt_data", "configs"), { data: window.configs }, { merge: true });
                document.getElementById("cloudStatusText").innerText = "Online";
            } catch(e) {
                console.error("Save Error", e);
                alert("Mentési hiba: " + e.message);
            }
        }

        window.pushTasks = async function() {
             if(!fsDB) return;
             try {
                await setDoc(doc(fsDB, "rvt_data", "tasks"), { list: window.tasks }, { merge: true });
             } catch(e) { console.error(e); }
        }
        
        window.pushHistory = async function() {
            if(!fsDB) return;
            try {
                // Keep only last 200 logs to prevent bloat
                if(window.logs.length > 200) window.logs = window.logs.slice(0, 200);
                await setDoc(doc(fsDB, "rvt_data", "history"), { list: window.logs }, { merge: true });
            } catch(e) { console.error(e); }
        }

        window.sendHeartbeat = function() {
            if(!fsDB || !window.currentUser) return;
            const uid = window.currentUser.id;
            const name = window.currentUser.name;
            const timestamp = Date.now();
            setDoc(doc(fsDB, "rvt_data", "presence"), { [uid]: { name: name, time: timestamp } }, { merge: true });
        }

        async function initializeDefaultDB() {
            const defUsers = [{ id: 1, name: "Admin", login: "admin", pass: "1234", role: "ADMIN", balance: 0, quota: 25, carriedOver: 0 }];
            await setDoc(doc(fsDB, "rvt_data", "users"), { list: defUsers });
            await setDoc(doc(fsDB, "rvt_data", "roster"), { data: {} });
            await setDoc(doc(fsDB, "rvt_data", "configs"), { data: {} });
            await setDoc(doc(fsDB, "rvt_data", "presence"), {});
            await setDoc(doc(fsDB, "rvt_data", "tasks"), { list: [] });
            await setDoc(doc(fsDB, "rvt_data", "history"), { list: [] });
        }

        initFirebaseSync();
    </script>

    <script>
        // --- DATA & STATE ---
        var users = [];
        var db = {}; 
        var configs = {}; 
        var tasks = []; 
        var logs = []; // History logs
        var currentUser = null;
        var heartbeatInterval = null;

        // --- INIT ---
        window.onload = function() {
            const y = new Date().getFullYear();
            const sY = document.getElementById("selYear");
            sY.innerHTML = "";
            for(let i=2023; i<=2030; i++) sY.innerHTML += `<option value="${i}" ${i===y?'selected':''}>${i}</option>`;
            document.getElementById("selMonth").value = new Date().getMonth();
        }

        // --- NAVIGATION LOGIC ---
        function openModule(moduleName) {
            document.getElementById("mainMenu").style.display = "none";
            document.getElementById("mainApp").style.display = "none";
            document.getElementById("taskApp").style.display = "none";

            if (moduleName === 'menu') {
                document.getElementById("mainMenu").style.display = "block";
            } else if (moduleName === 'roster') {
                document.getElementById("mainApp").style.display = "block";
                changePeriod(); 
                if(currentUser.role === 'ADMIN') renderHistory();
            } else if (moduleName === 'tasks') {
                document.getElementById("taskApp").style.display = "block";
                document.getElementById("taskUserInfo").innerText = `${currentUser.name} (${currentUser.role})`;
                renderTasks();
            }
        }

        // --- LOGIN & PERMISSIONS ---
        function applyPermissions() {
            const isAdmin = currentUser && currentUser.role === "ADMIN";
            document.querySelectorAll(".admin-only").forEach(el => {
                el.classList.toggle("hidden-perm", !isAdmin);
            });
            document.querySelectorAll(".clickable-header").forEach(el => {
                el.style.pointerEvents = isAdmin ? "auto" : "none";
                el.title = isAdmin ? "Kattints csoportos rögzítéshez!" : "";
            });
        }

        function performLogin() {
            const u = document.getElementById("loginUser").value;
            const p = document.getElementById("loginPass").value;
            let found = users.find(x => x.login === u && x.pass === p);
            
            if(found) {
                currentUser = found;
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("menuWelcomeText").innerText = `Üdvözöllek, ${currentUser.name}!`;
                openModule('menu');

                document.getElementById("userInfo").innerText = `Belépve: ${currentUser.name} (${currentUser.role})`;
                
                window.sendHeartbeat();
                heartbeatInterval = setInterval(window.sendHeartbeat, 60000);

                renderSettings();
                renderBatchSelect();
                applyPermissions();
            } else alert("Hibás felhasználónév vagy jelszó!");
        }

        function performLogout() { 
            if(confirm("Biztosan ki szeretne lépni?")) {
                if(heartbeatInterval) clearInterval(heartbeatInterval);
                location.reload(); 
            }
        }

        function renderPresence(presenceData) {
            const container = document.getElementById("activeUsersList");
            if(!presenceData) return;
            const now = Date.now();
            let activeNames = [];
            Object.keys(presenceData).forEach(uid => {
                const p = presenceData[uid];
                if (now - p.time < 5 * 60 * 1000) activeNames.push(p.name);
            });
            if(activeNames.length > 0) container.innerHTML = `<span class="online-dot"><i class="fa-solid fa-circle"></i></span> Jelenleg Online: ` + activeNames.join(", ");
            else container.innerHTML = "";
        }

        // --- PASSWORD CHANGE (MAIN MENU) ---
        function openChangePassModal() {
            document.getElementById("cpOldPass").value = "";
            document.getElementById("cpNewPass").value = "";
            document.getElementById("cpNewPass2").value = "";
            new bootstrap.Modal(document.getElementById('changePassModal')).show();
        }

        function saveNewPassword() {
            const oldP = document.getElementById("cpOldPass").value;
            const newP = document.getElementById("cpNewPass").value;
            const newP2 = document.getElementById("cpNewPass2").value;

            if(oldP !== currentUser.pass) return alert("A régi jelszó hibás!");
            if(newP.length < 3) return alert("A jelszó túl rövid!");
            if(newP !== newP2) return alert("A két új jelszó nem egyezik!");

            // Find user index reference to update global array
            const idx = users.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) {
                users[idx].pass = newP;
                currentUser.pass = newP; // Update local session
                if(window.pushData) window.pushData();
                alert("Jelszó sikeresen megváltoztatva!");
                bootstrap.Modal.getInstance(document.getElementById('changePassModal')).hide();
            }
        }

        // --- TASK MANAGER LOGIC (MULTI SELECT & PRIORITY) ---
        function openAddTaskModal() {
            // Populate user checklist
            const s = document.getElementById("taskMultiSelectDiv");
            let html = `
                <div class="form-check border-bottom pb-1 mb-1">
                    <input class="form-check-input" type="checkbox" id="chkAll" onchange="toggleTaskAll()">
                    <label class="form-check-label fw-bold" for="chkAll">MINDENKI</label>
                </div>
            `;
            users.forEach(u => {
                if(u.role !== "VIEWER") {
                    html += `
                    <div class="form-check">
                        <input class="form-check-input task-user-chk" type="checkbox" value="${u.id}" id="chk_u_${u.id}">
                        <label class="form-check-label" for="chk_u_${u.id}">${u.name}</label>
                    </div>`;
                }
            });
            s.innerHTML = html;

            // Default date: tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById("taskDeadlineDate").value = tomorrow.toISOString().split('T')[0];
            
            // Reset Priority
            document.getElementById("prioBlue").checked = true;

            new bootstrap.Modal(document.getElementById('addTaskModal')).show();
        }

        function toggleTaskAll() {
            const allChecked = document.getElementById("chkAll").checked;
            document.querySelectorAll(".task-user-chk").forEach(c => c.checked = allChecked);
        }

        function saveNewTask() {
            const title = document.getElementById("taskTitle").value;
            const desc = document.getElementById("taskDesc").value;
            const date = document.getElementById("taskDeadlineDate").value;
            const time = document.getElementById("taskDeadlineTime").value;
            const priority = document.querySelector('input[name="taskPrio"]:checked').value; // RED, YELLOW, BLUE
            
            // Gather selected users
            let assign = [];
            const allChecked = document.getElementById("chkAll").checked;
            
            if (allChecked) {
                assign = "ALL";
            } else {
                document.querySelectorAll(".task-user-chk:checked").forEach(c => {
                    assign.push(c.value);
                });
            }

            if(!title || !date) return alert("Cím és Dátum kötelező!");
            if(assign !== "ALL" && assign.length === 0) return alert("Nincs felelős kiválasztva!");

            const newTask = {
                id: Date.now(),
                title: title,
                desc: desc,
                deadline: `${date} ${time}`,
                priority: priority,
                assignedTo: assign, // "ALL" or Array of IDs
                createdBy: currentUser.name,
                completions: {} 
            };

            tasks.push(newTask);
            if(window.pushTasks) window.pushTasks();
            
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            renderTasks();
        }

        function renderTasks() {
            const activeList = document.getElementById("activeTasksList");
            const doneList = document.getElementById("completedTasksList");
            activeList.innerHTML = "";
            doneList.innerHTML = "";
            tasks.sort((a,b) => new Date(a.deadline) - new Date(b.deadline));

            let hasActive = false;

            tasks.forEach(t => {
                // Check Visibility
                let isAssigned = false;
                if(t.assignedTo === "ALL") isAssigned = true;
                else if(Array.isArray(t.assignedTo)) isAssigned = t.assignedTo.includes(String(currentUser.id));
                else if(t.assignedTo == currentUser.id) isAssigned = true; // Legacy support
                
                const isAdmin = (currentUser.role === "ADMIN");

                if(!isAssigned && !isAdmin) return;

                // Status Check
                const amIDone = t.completions && t.completions[currentUser.id];
                
                // Determine Assignment Text
                let assignText = "Mindenki";
                if(t.assignedTo !== "ALL") {
                   if(Array.isArray(t.assignedTo)) {
                       assignText = t.assignedTo.length + " fő";
                       if(t.assignedTo.length < 4) {
                           assignText = t.assignedTo.map(uid => {
                               const u = users.find(x => x.id == uid);
                               return u ? u.name : "?";
                           }).join(", ");
                       }
                   } else {
                       const u = users.find(x => x.id == t.assignedTo);
                       assignText = u ? u.name : "???";
                   }
                }

                // Priority Class & Color
                let prioClass = `task-priority-${t.priority || 'BLUE'}`;
                if(amIDone) prioClass = 'task-done';

                const cardHtml = `
                    <div class="card task-card ${prioClass} shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title fw-bold task-title">${t.title}</h5>
                                <span class="badge bg-secondary task-badge align-self-start"><i class="fa-solid fa-clock"></i> ${t.deadline.replace('T', ' ')}</span>
                            </div>
                            <p class="card-text mb-2 text-muted small" style="white-space: pre-wrap;">${t.desc || 'Nincs leírás'}</p>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <small class="text-primary fw-bold"><i class="fa-solid fa-user"></i> Felelős: ${assignText}</small>
                                ${getActionButtons(t, amIDone, isAdmin, isAssigned)}
                            </div>
                            ${getAdminDetails(t, isAdmin)}
                        </div>
                    </div>
                `;

                if(amIDone) {
                    doneList.innerHTML += cardHtml; 
                } else {
                    hasActive = true;
                    activeList.innerHTML += cardHtml;
                }
            });
            
            if(!hasActive) activeList.innerHTML = `<div class="text-center text-muted p-4"><i class="fa-solid fa-check-circle fa-2x mb-2"></i><br>Nincs aktív feladatod!</div>`;
        }

        function getActionButtons(task, isDone, isAdmin, isAssigned) {
            if(currentUser.role === "VIEWER") return "";
            let html = "";
            if(isAssigned) {
                if(isDone) {
                    html += `<button class="btn btn-sm btn-outline-success disabled"><i class="fa-solid fa-check"></i> Elvégezve</button>`;
                } else {
                    html += `<button class="btn btn-sm btn-success" onclick="openCompleteModal(${task.id})">Elvégeztem</button>`;
                }
            }
            if(isAdmin) {
                // Ensure taskId is passed as a safe number/string
                html += `<button class="btn btn-sm btn-outline-danger ms-2" title="Feladat törlése" onclick="window.deleteTask(${task.id})"><i class="fa-solid fa-trash"></i></button>`;
            }
            return html;
        }

        function getAdminDetails(task, isAdmin) {
            if(!isAdmin) return "";
            const doneCount = Object.keys(task.completions || {}).length;
            let finishedInfo = [];
            Object.keys(task.completions || {}).forEach(uid => {
                const u = users.find(x => x.id == uid);
                const cData = task.completions[uid];
                let note = "";
                // Handle new object structure vs old string structure
                if(typeof cData === 'object') {
                    note = cData.note ? ` (${cData.note})` : "";
                }
                if(u) finishedInfo.push(`${u.name}${note}`);
            });
            return `<div class="mt-2 pt-2 border-top small text-muted">
                Admin Infó: Kész (${doneCount} fő): ${finishedInfo.join(', ') || '-'}
            </div>`;
        }

        // NEW: Open Completion Modal
        function openCompleteModal(taskId) {
            document.getElementById("completeTaskId").value = taskId;
            document.getElementById("completionNote").value = "";
            new bootstrap.Modal(document.getElementById('completeTaskModal')).show();
        }

        // NEW: Finish Task Logic
        function finishTask() {
            const taskId = document.getElementById("completeTaskId").value;
            const note = document.getElementById("completionNote").value;
            
            const task = tasks.find(t => t.id == taskId);
            if(!task) return;
            if(!task.completions) task.completions = {};
            
            // Store completion as object with note
            task.completions[currentUser.id] = {
                date: new Date().toISOString(),
                note: note
            };
            
            if(window.pushTasks) window.pushTasks();
            renderTasks();
            bootstrap.Modal.getInstance(document.getElementById('completeTaskModal')).hide();
        }

        window.deleteTask = function(taskId) {
            if(currentUser.role !== "ADMIN") return alert("Ehhez csak Adminnak van jogosultsága!");
            if(!confirm("Biztosan törlöd a feladatot mindenki számára?")) return;
            const idx = tasks.findIndex(t => t.id == taskId);
            if(idx > -1) {
                tasks.splice(idx, 1);
                if(window.pushTasks) window.pushTasks();
                renderTasks();
            } else {
                alert("Hiba: Feladat nem található.");
            }
        }

        // --- BACKUP (JSON) ---
        function exportBackup() {
            if(currentUser.role !== "ADMIN") return alert("Ehhez csak Adminnak van jogosultsága!");
            const backupData = { timestamp: new Date().toISOString(), version: "7.1-Integrated", users: users, db: db, configs: configs, tasks: tasks, history: logs };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `rvt_utils_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function processBackupImport(input) {
            if(currentUser.role !== "ADMIN") return alert("Ehhez csak Adminnak van jogosultsága!");
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.users && importedData.db) {
                        if(confirm("FIGYELEM! A betöltés felülírja a felhőben lévő adatokat (Feladatokat is). Folytatod?")) {
                            users = importedData.users;
                            db = importedData.db;
                            configs = importedData.configs || {};
                            tasks = importedData.tasks || []; 
                            logs = importedData.history || [];
                            if(window.pushData) window.pushData(); 
                            if(window.pushTasks) window.pushTasks();
                            if(window.pushHistory) window.pushHistory();
                            alert("Sikeres visszatöltés! Az adatok szinkronizálva.");
                        }
                    } else alert("Hibás fájlstruktúra!");
                } catch(err) { console.error(err); alert("Hiba: " + err.message); }
                input.value = "";
            };
            reader.readAsText(file);
        }

        // --- HISTORY LOGIC ---
        function logHistory(targetUserName, dateText, actionType, details = "") {
            const entry = {
                ts: Date.now(),
                actor: currentUser.name,
                target: targetUserName,
                date: dateText,
                action: actionType,
                details: details // New Field
            };
            logs.unshift(entry); // Add to top
            if(window.pushHistory) window.pushHistory();
            if(document.getElementById("tab-history").classList.contains("active")) renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById("historyLogList");
            list.innerHTML = "";
            if(!logs || logs.length === 0) {
                list.innerHTML = '<p class="text-muted text-center">Nincs megjeleníthető adat.</p>';
                return;
            }
            logs.forEach(l => {
                const dateObj = new Date(l.ts);
                const timeStr = dateObj.toLocaleString('hu-HU');
                const detailsHtml = l.details ? `<span class="log-diff">${l.details}</span>` : "";
                list.innerHTML += `
                    <div class="log-entry">
                        <div class="d-flex justify-content-between">
                            <span class="log-user">${l.actor}</span>
                            <span class="log-time">${timeStr}</span>
                        </div>
                        <div>
                            <span class="fw-bold">${l.action}</span> - 
                            <span class="text-muted">${l.target} (${l.date})</span>
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            });
        }
        
        function clearHistory() {
            if(currentUser.role !== "ADMIN") return alert("Csak Admin törölheti az előzményeket!");
            if(!confirm("Biztosan TÖRLÖD a teljes módosítási történetet? Ez nem visszavonható.")) return;
            logs = [];
            if(window.pushHistory) window.pushHistory();
            renderHistory();
        }

        function exportHistoryCSV() {
             if(currentUser.role !== "ADMIN") return alert("Csak Admin exportálhat!");
             let csv = "\uFEFFIdőpont;Felhasználó (Aki módosított);Művelet;Célpont;Dátum;Részletek\n";
             logs.forEach(l => {
                 const timeStr = new Date(l.ts).toLocaleString('hu-HU');
                 // Escape semicolons and newlines in details
                 const cleanDetails = (l.details || "").replace(/;/g, ",").replace(/\n/g, " ");
                 csv += `${timeStr};${l.actor};${l.action};${l.target};${l.date};${cleanDetails}\n`;
             });
             
             const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `rvt_history_log_${new Date().toISOString().slice(0,10)}.csv`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
        }

        // --- CORE ROSTER LOGIC ---
        function changePeriod() {
            calculateNormaForUI(true);
            loadConfigForPeriod();
            renderRoster();
            applyPermissions(); 
            if(document.getElementById("tab-users").classList.contains("active")) renderSettings();
            if(currentUser && currentUser.role === 'ADMIN' && document.getElementById("tab-history").classList.contains("active")) renderHistory();
        }

        function getKey() {
            const y = document.getElementById("selYear").value;
            const m = parseInt(document.getElementById("selMonth").value) + 1;
            return `${y}-${m}`;
        }

        function calculateNorma(y, m, holidays, workWeekends) {
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            let workDays = 0;
            const swapOnDays = workWeekends.map(w => w.day);
            const swapOffDays = workWeekends.map(w => w.swap).filter(x => x);

            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(y, m, d);
                const dayOfWeek = date.getDay(); 
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                const isHoliday = holidays.includes(d);
                if (isHoliday) continue; 
                if (swapOffDays.includes(d)) continue;
                if (swapOnDays.includes(d)) { workDays++; continue; }
                if (!isWeekend) workDays++;
            }
            return workDays * 8;
        }

        function calculateNormaForUI(isAuto = false) {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const holStr = document.getElementById("configHolidays").value;
            const holidays = holStr ? holStr.split(",").map(x=>parseInt(x.trim())).filter(x=>!isNaN(x)) : [];
            const wwStr = document.getElementById("configWorkWeekends").value;
            let workWeekends = [];
            if(wwStr) {
                workWeekends = wwStr.split(",").map(s => {
                    s = s.trim();
                    if(s.includes("=")) {
                        const parts = s.split("=");
                        return { day: parseInt(parts[0]), swap: parseInt(parts[1]) };
                    } else {
                        const val = parseInt(s);
                        return !isNaN(val) ? { day: val, swap: null } : null;
                    }
                }).filter(x => x && !isNaN(x.day));
            }
            document.getElementById("configNorma").value = calculateNorma(y, m, holidays, workWeekends);
        }

        // --- MISSING FUNCTIONS FIXED ---
        function calculateUsedLeave(uId, year) {
            let count = 0;
            for (let m = 1; m <= 12; m++) {
                const key = `${year}-${m}`;
                if (db[key] && db[key][uId]) {
                    Object.values(db[key][uId]).forEach(entry => {
                        if (entry.type === 'X') count++;
                    });
                }
            }
            return count;
        }

        function openUserProfile(uId) {
            const u = users.find(x => x.id == uId);
            if(!u) return;
            document.getElementById("profileUserId").value = u.id;
            document.getElementById("profileName").innerText = u.name;
            document.getElementById("profileLogin").innerText = `@${u.login} (${u.role})`;
            
            // Stats
            const y = parseInt(document.getElementById("selYear").value);
            document.getElementById("profileYear").innerText = y;
            const used = calculateUsedLeave(u.id, y);
            const total = (u.quota || 0) + (u.carriedOver || 0);
            document.getElementById("profileLeaveStats").innerText = `${used} / ${total} nap`;
            
            const pct = total > 0 ? (used / total) * 100 : 0;
            const bar = document.getElementById("profileLeaveProgress");
            bar.style.width = `${pct}%`;
            bar.className = `progress-bar ${pct > 100 ? 'bg-danger' : (pct > 80 ? 'bg-warning' : 'bg-success')}`;

            // Admin Panel Visibility
            const adminPanel = document.getElementById("adminProfilePanel");
            const adminOverride = document.getElementById("adminOverrideDiv");
            const oldPassDiv = document.getElementById("oldPassDiv");
            
            if(currentUser.role === 'ADMIN') {
                adminPanel.style.display = "block";
                document.getElementById("profileQuotaInput").value = u.quota;
                document.getElementById("profileCarriedInput").value = u.carriedOver;
                adminOverride.style.display = "block";
                oldPassDiv.style.display = "none";
            } else {
                adminPanel.style.display = "none";
                adminOverride.style.display = "none";
                oldPassDiv.style.display = "block";
            }

            // Reset password fields
            document.getElementById("profileOldPass").value = "";
            document.getElementById("profileNewPass").value = "";

            new bootstrap.Modal(document.getElementById('userProfileModal')).show();
        }

        function saveProfileChanges() {
            const uId = document.getElementById("profileUserId").value;
            const uIdx = users.findIndex(x => x.id == uId);
            if(uIdx === -1) return;
            
            const u = users[uIdx];
            const oldP = document.getElementById("profileOldPass").value;
            const newP = document.getElementById("profileNewPass").value;
            
            // Password logic
            if (newP) {
                if(currentUser.role !== 'ADMIN') {
                     if(oldP !== u.pass) return alert("Hibás régi jelszó!");
                }
                users[uIdx].pass = newP;
                // update session if self
                if(currentUser.id == uId) currentUser.pass = newP;
                alert("Jelszó módosítva!");
            }

            // Admin config logic
            if(currentUser.role === 'ADMIN') {
                 const q = parseInt(document.getElementById("profileQuotaInput").value);
                 const c = parseInt(document.getElementById("profileCarriedInput").value);
                 users[uIdx].quota = q;
                 users[uIdx].carriedOver = c;
            }

            if(window.pushData) window.pushData();
            renderRoster(); // refresh UI
            bootstrap.Modal.getInstance(document.getElementById('userProfileModal')).hide();
        }
        
        // --- RESTORED MISSING FUNCTIONS ---
        function renderRoster() {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const key = getKey();
            const monthData = db[key] || {};
            const conf = configs[key] || { norma: 168, holidays: [], workWeekends: [] };

            const thead = document.getElementById("rosterHead");
            const tbody = document.getElementById("rosterBody");
            
            const dayNames = ['V','H','K','S','C','P','S'];
            let hRow = `<tr><th style="min-width:150px; background:white;">Név:</th>`;
            
            let swapOnDays = [];
            if(conf.workWeekends && conf.workWeekends.length > 0) {
                 if(typeof conf.workWeekends[0] === 'object') {
                       swapOnDays = conf.workWeekends.map(w => w.day);
                 } else {
                       swapOnDays = conf.workWeekends;
                 }
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(y, m, i);
                const dayOfWeek = date.getDay();
                let thClass = "";
                if (conf.holidays.includes(i)) thClass = "th-hol";
                else if (dayOfWeek === 6 && !swapOnDays.includes(i)) thClass = "th-sat";
                else if (dayOfWeek === 0 && !swapOnDays.includes(i)) thClass = "th-sun";
                hRow += `<th class="${thClass} clickable-header" onclick="openColumnBatch(${i})">${i}.<br>${dayNames[dayOfWeek]}</th>`;
            }
            hRow += `<th style="min-width:80px">Norma / Telj.</th><th style="min-width:60px">Túlsz.</th></tr>`;
            thead.innerHTML = hRow;
            
            const monthName = document.getElementById("selMonth").options[m].text;
            document.getElementById("printSubtitle").innerText = `${y}. ${monthName}`;

            tbody.innerHTML = "";
            users.forEach(u => {
                if(u.role === "VIEWER") return;

                let rowHtml = `<tr data-uid="${u.id}"><td class="name-col" onclick="openUserProfile(${u.id})">${u.name}</td>`;
                let totalHours = 0, monthOvertime = 0;
                const uData = monthData[u.id] || {};

                for (let i = 1; i <= daysInMonth; i++) {
                    const entry = uData[i];
                    let content = "", cls = "", noteIndicator="";
                    if (entry) {
                        if(entry.note && entry.note.trim() !== "") {
                            noteIndicator = `<div class="note-indicator" title="${entry.note}"></div>`;
                        }

                        if (entry.type === "WORK") {
                            content = `${entry.start}-${entry.end}`;
                            if(entry.overtime > 0) content += `<br><span class="text-danger fw-bold">+${entry.overtime}</span>`;
                            totalHours += parseFloat(entry.hours);
                        } else if (entry.type === "TM") { content = "TM"; cls = "cell-tm"; }
                        else {
                            content = entry.type;
                            if(entry.type==="X") { cls="cell-x"; totalHours += parseFloat(entry.hours); }
                            if(entry.type==="RSZ") { cls="cell-rsz"; totalHours += parseFloat(entry.hours); } 
                            if(entry.type==="B") { cls="cell-b"; totalHours += parseFloat(entry.hours); }
                            if(entry.type==="PN"||entry.type==="PI") cls="cell-pn";
                        }
                        if(entry.overtime) monthOvertime += parseFloat(entry.overtime);
                        
                        if(entry.sport > 0) {
                            content += `<span class="text-sport"><i class="fa-solid fa-dumbbell"></i> ${entry.sport}p</span>`;
                        }
                    }
                    rowHtml += `<td class="roster-cell ${cls}" onclick="openEdit(${u.id}, ${i})">${content}${noteIndicator}</td>`;
                }
                const norma = parseInt(conf.norma);
                let hourClass = totalHours < norma ? "hour-under" : (totalHours > norma ? "hour-over" : "hour-ok");
                
                let currentMonthChange = monthOvertime;
                Object.values(uData).forEach(e => { if(e.type === "TM") currentMonthChange -= 8; });
                const finalBalance = (parseFloat(u.balance) || 0) + currentMonthChange;
                const balCol = finalBalance < 0 ? "text-danger" : "text-success";

                rowHtml += `<td class="${hourClass}">${norma} / ${totalHours}</td><td class="${balCol} fw-bold">${finalBalance}</td></tr>`;
                tbody.innerHTML += rowHtml;
            });
        }

        function openEdit(uId, day) {
            const isViewer = currentUser.role === "VIEWER";
            const isAdmin = currentUser.role === "ADMIN";
            const key = getKey();
            const existing = db[key]?.[uId]?.[day];

            if (!isViewer && !isAdmin) {
                if (uId !== currentUser.id) return alert("Csak a saját sorodat szerkesztheted!");
            }

            document.getElementById("editUserId").value = uId;
            document.getElementById("editDay").value = day;
            document.getElementById("sportTime").value = ""; 

            const restrictMsg = document.getElementById("userRestrictMsg");
            if (!isAdmin && !isViewer) {
                 restrictMsg.style.display = "block";
            } else {
                 restrictMsg.style.display = "none";
            }

            if (existing) {
                const rType = document.querySelector(`input[name="sType"][value="${existing.type}"]`);
                if(rType) rType.checked = true; else document.getElementById("stWork").checked = true;

                if(existing.type==="WORK") {
                    document.getElementById("startTime").value = existing.start;
                    document.getElementById("endTime").value = existing.end;
                    document.getElementById("calcHours").value = existing.hours;
                    document.getElementById("overtimeVal").value = existing.overtime || 0;
                } else {
                    document.getElementById("calcHours").value = existing.hours;
                    document.getElementById("overtimeVal").value = 0;
                }
                document.getElementById("dayNote").value = existing.note || "";
                document.getElementById("sportTime").value = existing.sport || "";
            } else {
                document.getElementById("stWork").checked = true;
                document.getElementById("startTime").value = "07:00";
                document.getElementById("endTime").value = "15:30";
                document.getElementById("dayNote").value = "";
                calcHours();
            }
            toggleModalFields();
            
            const modalTitle = document.getElementById("editModalTitle");
            const btnContainer = document.getElementById("editButtons");
            const inputs = document.querySelectorAll("#editModalContent input");
            const noteInput = document.getElementById("dayNote");

            if(isViewer) {
                modalTitle.innerText = "Részletek Megtekintése (Csak Olvasható)";
                btnContainer.style.display = "none";
                inputs.forEach(el => el.disabled = true);
                noteInput.disabled = true;
            } else if (!isAdmin) {
                modalTitle.innerText = "Megjegyzés Hozzáadása";
                btnContainer.style.display = "block";
                inputs.forEach(el => el.disabled = true);
                noteInput.disabled = false;
                toggleModalFields();
            } else {
                modalTitle.innerText = "Napi Beosztás Szerkesztése";
                btnContainer.style.display = "block";
                inputs.forEach(el => el.disabled = false);
                noteInput.disabled = false;
                toggleModalFields();
            }

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function toggleModalFields() {
            if(currentUser.role === "VIEWER") return; 
            const t = document.querySelector('input[name="sType"]:checked').value;
            const tf = document.getElementById("timeFields");
            const ov = document.getElementById("overtimeVal");
            
            if(t === "B" || t === "TM") { ov.value = 0; ov.disabled = true; } else { if(currentUser.role === 'ADMIN') ov.disabled = false; }
            if(t==="WORK") { tf.style.display="block"; calcHours(); } 
            else { 
                tf.style.display="none"; 
                document.getElementById("calcHours").value = (t==="X"||t==="B"||t==="RSZ") ? 8 : 0; 
                if(t!=="WORK") ov.value = 0;
            }
        }

        function calcHours() {
            if(!document.getElementById("stWork").checked) return;
            const s = document.getElementById("startTime").value;
            const e = document.getElementById("endTime").value;
            document.getElementById("calcHours").value = calculateDiff(s, e);
        }
        function calculateDiff(s, e) {
            const sp = s.split(":"); const ep = e.split(":");
            let diff = (parseInt(ep[0])*60+parseInt(ep[1]) - (parseInt(sp[0])*60+parseInt(sp[1])))/60;
            if(diff < 0) diff += 24; return diff;
        }

        function getGlobalEntry(uId, year, month, day) {
            const k = `${year}-${month + 1}`;
            if(db[k] && db[k][uId] && db[k][uId][day]) {
                return db[k][uId][day];
            }
            return null;
        }

        function checkWeeklySportLimit(uId, currentYear, currentMonth, currentDay, newSportVal) {
            const date = new Date(currentYear, currentMonth, currentDay);
            const dayOfWeek = date.getDay(); 
            const distToMon = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
            const mondayDate = new Date(date);
            mondayDate.setDate(date.getDate() - distToMon);

            let weeklySum = 0;
            for(let i=0; i<7; i++) {
                const d = new Date(mondayDate);
                d.setDate(mondayDate.getDate() + i);
                if(d.getFullYear() === currentYear && d.getMonth() === currentMonth && d.getDate() === currentDay) {
                    weeklySum += newSportVal;
                } else {
                    const entry = getGlobalEntry(uId, d.getFullYear(), d.getMonth(), d.getDate());
                    if(entry && entry.sport) {
                        weeklySum += parseInt(entry.sport);
                    }
                }
            }
            return weeklySum;
        }

        function saveEntry() {
            if (currentUser.role === "VIEWER") return;
            const uId = document.getElementById("editUserId").value;
            const day = parseInt(document.getElementById("editDay").value);
            const key = getKey();
            
            const sportVal = parseInt(document.getElementById("sportTime").value) || 0;
            if(sportVal > 0 && currentUser.role === 'ADMIN') { 
                const y = parseInt(document.getElementById("selYear").value);
                const m = parseInt(document.getElementById("selMonth").value);
                const weeklySum = checkWeeklySportLimit(uId, y, m, day, sportVal);
                
                if(weeklySum > 120) {
                    if(!confirm(`FIGYELEM!\nA heti sport limit (120 perc) túl lesz lépve!\n\nJelenlegi heti összesen: ${weeklySum} perc.\n\nBiztosan rögzíted?`)) return; 
                }
            }

            if(!db[key]) db[key] = {}; if(!db[key][uId]) db[key][uId] = {};
            
            const newNote = document.getElementById("dayNote").value.trim();
            const type = document.querySelector('input[name="sType"]:checked').value;
            
            // LOGGING - COMPARE OLD vs NEW
            const oldEntry = db[key][uId][day] || { type:"", start:"", end:"", hours:0, overtime:0, note:"", sport:0 };
            
            let entry = {};
            let logAction = "";
            let logDetails = [];

            if (currentUser.role !== 'ADMIN') {
                // USER MODE
                const existing = db[key][uId][day];
                if(existing) {
                    entry = { ...existing, note: newNote };
                    if(existing.note !== newNote) logDetails.push(`Megj: "${existing.note}" -> "${newNote}"`);
                    logAction = "Megjegyzés módosítása";
                } else {
                    entry = { type: "WORK", start:"", end:"", hours:0, overtime:0, note: newNote, sport:0 };
                    logAction = "Új megjegyzés (üres napra)";
                    logDetails.push(`"${newNote}"`);
                }
            } else {
                // ADMIN MODE
                const newStart = type==="WORK"?document.getElementById("startTime").value:"";
                const newEnd = type==="WORK"?document.getElementById("endTime").value:"";
                const newHours = parseFloat(document.getElementById("calcHours").value)||0;
                const newOvertime = parseFloat(document.getElementById("overtimeVal").value)||0;

                entry = {
                    type: type,
                    start: newStart,
                    end: newEnd,
                    hours: newHours,
                    overtime: newOvertime,
                    note: newNote,
                    sport: sportVal 
                };
                
                // Compare logic
                const typeNames = { "WORK": "Szolgálat", "X": "Szabadság", "B": "Beteg", "RSZ": "Rendkívüli", "PN": "Pihenőnap", "PI": "Pihenőidő", "TM": "Megváltás" };

                // 1. Service -> Absence
                if(oldEntry.type === "WORK" && ["X", "B", "RSZ"].includes(type)) {
                    const oldTime = `${oldEntry.start}-${oldEntry.end}`;
                    const newLabel = typeNames[type] || type;
                    logDetails.push(`Szolgálat (${oldTime}) -> ${newLabel}`);
                } 
                // 2. Absence -> Service (New Feature)
                else if (["X", "B", "RSZ"].includes(oldEntry.type) && type === "WORK") {
                     const oldLabel = typeNames[oldEntry.type] || oldEntry.type;
                     logDetails.push(`${oldLabel} -> Szolgálat (${newStart}-${newEnd})`);
                }
                // 3. Generic Change
                else if (oldEntry.type !== type) {
                    logDetails.push(`Típus: ${oldEntry.type} -> ${type}`);
                }

                // Time change logic (only if still WORK)
                if(type === "WORK" && oldEntry.type === "WORK" && (oldEntry.start !== newStart || oldEntry.end !== newEnd)) {
                     logDetails.push(`Idő: ${oldEntry.start}-${oldEntry.end} -> ${newStart}-${newEnd}`);
                }
                
                if(oldEntry.overtime != newOvertime) logDetails.push(`Túlsz: ${oldEntry.overtime} -> ${newOvertime}`);
                
                // Sport Change - Only if changed from non-zero to zero or vice versa or changed value
                const oldSport = parseInt(oldEntry.sport) || 0;
                const newSport = parseInt(sportVal) || 0;
                if(oldSport !== newSport) {
                     logDetails.push(`Sport: ${oldSport}p -> ${newSport}p`);
                }

                if(oldEntry.note !== newNote) logDetails.push(`Megj: ...`);

                logAction = `Módosítás`;
            }

            db[key][uId][day] = entry;
            
            // LOGGING
            const targetUser = users.find(x => x.id == uId);
            const y = document.getElementById("selYear").value;
            const m = parseInt(document.getElementById("selMonth").value) + 1;
            const dateStr = `${y}-${m}-${day}`;
            
            if(logDetails.length > 0) {
                 logHistory(targetUser ? targetUser.name : "???", dateStr, logAction, logDetails.join(", "));
            }

            if(window.pushData) window.pushData(); renderRoster();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        function deleteEntry() {
            if (currentUser.role === "VIEWER") return;
            const uId = document.getElementById("editUserId").value;
            if (currentUser.role !== "ADMIN" && uId != currentUser.id) return;
            if(currentUser.role !== "ADMIN") { alert("Törlést csak Admin végezhet."); return; }

            const day = document.getElementById("editDay").value;
            const key = getKey();
            if(db[key] && db[key][uId]) {
                 delete db[key][uId][day];
                 const targetUser = users.find(x => x.id == uId);
                 const y = document.getElementById("selYear").value;
                 const m = parseInt(document.getElementById("selMonth").value) + 1;
                 const dateStr = `${y}-${m}-${day}`;
                 logHistory(targetUser ? targetUser.name : "???", dateStr, "Törlés", "Teljes bejegyzés törölve");
            }
            if(window.pushData) window.pushData(); renderRoster();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        // --- BATCH & PRINT ---
        function openColumnBatch(day) {
             if(currentUser.role !== "ADMIN") return alert("Csak Admin rögzíthet csoportosan!");
             document.getElementById("colBatchDay").value = day;
             document.getElementById("colBatchDayDisplay").innerText = day + ". nap";
             new bootstrap.Modal(document.getElementById('colBatchModal')).show();
        }
        function toggleColBatchTime() {
             const t = document.getElementById("colBatchType").value; document.getElementById("colBatchTimeDiv").style.display = (t === "WORK") ? "block" : "none";
        }
        function saveColBatch() {
             const day = document.getElementById("colBatchDay").value;
             const type = document.getElementById("colBatchType").value;
             const key = getKey();
             if(!db[key]) db[key] = {};
             users.forEach(u => {
                 if(!db[key][u.id]) db[key][u.id] = {};
                 let entry = { type: type, hours: 0, start: "", end: "", overtime: 0, note: "" };
                 if(type === "WORK") {
                    entry.start = document.getElementById("colBatchStart").value;
                    entry.end = document.getElementById("colBatchEnd").value;
                    entry.hours = calculateDiff(entry.start, entry.end);
                 } else if (type === "X" || type === "B" || type === "RSZ") { entry.hours = 8; }
                 db[key][u.id][day] = entry;
             });
             
             // Simple Batch Log
             const y = document.getElementById("selYear").value;
             const m = parseInt(document.getElementById("selMonth").value) + 1;
             logHistory("MINDENKI", `${y}-${m}-${day}`, `Csoportos: ${type}`, "Mindenki felülírva");

             if(window.pushData) window.pushData(); renderRoster();
             bootstrap.Modal.getInstance(document.getElementById('colBatchModal')).hide();
        }
        
        function openPrintModal() {
            const list = document.getElementById("printUserList"); list.innerHTML = "";
            users.forEach(u => { 
                if(u.role === "VIEWER") return;
                list.innerHTML += `<label class="list-group-item"><input class="form-check-input me-1 print-check" type="checkbox" value="${u.id}" checked>${u.name}</label>`; 
            });
            new bootstrap.Modal(document.getElementById('printModal')).show();
        }
        function toggleAllPrint(state) { document.querySelectorAll(".print-check").forEach(c => c.checked = true); }
        function executePrint() {
            const selectedIds = Array.from(document.querySelectorAll(".print-check:checked")).map(c => c.value);
            const rows = document.querySelectorAll("#mainRosterTable tbody tr");
            rows.forEach(r => {
                const uid = r.getAttribute("data-uid");
                if(selectedIds.includes(uid)) r.classList.remove("print-hidden-row"); else r.classList.add("print-hidden-row");
            });
            
            const today = new Date();
            const dateStr = `${today.getFullYear()}. ${today.toLocaleString('hu-HU', { month: 'long' })} ${today.getDate()}.`;
            document.getElementById('printDate').innerText = dateStr;

            bootstrap.Modal.getInstance(document.getElementById('printModal')).hide();
            setTimeout(() => { window.print(); setTimeout(() => { rows.forEach(r => r.classList.remove("print-hidden-row")); }, 1000); }, 500);
        }
        
        function renderBatchSelect() {
            const s = document.getElementById("batchUserSelect"); s.innerHTML = `<option value="ALL">-- MINDENKI --</option>`;
            users.forEach(u => {
                if(u.role === "VIEWER") return;
                s.innerHTML += `<option value="${u.id}">${u.name}</option>`;
            });
        }
        function toggleBatchTime() {
            const t = document.getElementById("batchType").value; document.getElementById("batchTimeInputs").style.display = (t === "WORK") ? "block" : "none";
        }
        function applyBatch() {
            const uId = document.getElementById("batchUserSelect").value;
            const startD = parseInt(document.getElementById("batchStartDay").value);
            const endD = parseInt(document.getElementById("batchEndDay").value);
            const type = document.getElementById("batchType").value;
            const key = getKey();
            if(!db[key]) db[key] = {};
            const targetUsers = (uId === "ALL") ? users : users.filter(u => u.id == uId);
            targetUsers.forEach(u => {
                if(!db[key][u.id]) db[key][u.id] = {};
                for(let i=startD; i<=endD; i++) {
                    let entry = { type: type, hours: 0, start: "", end: "", overtime: 0, note: "" };
                    if(type === "WORK") {
                        entry.start = document.getElementById("batchStartTime").value;
                        entry.end = document.getElementById("batchEndTime").value;
                        entry.hours = calculateDiff(entry.start, entry.end);
                    } else if(type === "X" || type === "B" || type === "RSZ") entry.hours = 8;
                    db[key][u.id][i] = entry;
                }
            });

            // Batch Log
            const y = document.getElementById("selYear").value;
            const m = parseInt(document.getElementById("selMonth").value) + 1;
            const targetName = (uId === "ALL") ? "MINDENKI" : (users.find(x=>x.id==uId)?.name || "???");
            logHistory(targetName, `${y}-${m} (${startD}-${endD})`, `Többnapos: ${type}`);

            if(window.pushData) window.pushData(); renderRoster(); alert("Sikeres rögzítés!");
        }

        // --- SETTINGS ---
        function renderSettings() {
            const tb = document.getElementById("userSettingsTable"); tb.innerHTML = "";
            const currentYear = parseInt(document.getElementById("selYear").value);
            document.getElementById("currentAdminYearDisplay").innerText = `Adatok erre az évre: ${currentYear}`;

            users.forEach((u, idx) => {
                const q = u.quota || 20;
                const c = u.carriedOver || 0;
                const total = q + c;
                const used = calculateUsedLeave(u.id, currentYear);
                const warnClass = used > total ? "text-danger fw-bold" : "text-success";
                
                tb.innerHTML += `<tr>
                    <td><input type="text" class="form-control form-control-sm" value="${u.name}" onchange="updateUser(${idx},'name',this.value)"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${u.login}" onchange="updateUser(${idx},'login',this.value)"></td>
                    <td><input type="text" class="form-control form-control-sm border-warning" placeholder="Új jelszó..." onchange="updateUserPass(${idx}, this.value)"></td>
                    <td><select class="form-select form-select-sm" onchange="updateUser(${idx},'role',this.value)">
                        <option value="USER" ${u.role==='USER'?'selected':''}>User</option>
                        <option value="VIEWER" ${u.role==='VIEWER'?'selected':''}>Betekintő</option>
                        <option value="ADMIN" ${u.role==='ADMIN'?'selected':''}>Admin</option>
                    </select></td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" style="width:50px" title="Idei Keret" value="${q}" onchange="updateUser(${idx},'quota',this.value)">
                            <span class="input-group-text">+</span>
                            <input type="number" class="form-control" style="width:50px" title="Áthozott (Tavalyi)" value="${c}" onchange="updateUser(${idx},'carriedOver',this.value)">
                            <span class="input-group-text ${warnClass}" style="min-width: 80px;">Kivett: ${used}</span>
                        </div>
                    </td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteUser(${idx})"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function setAllUserQuota() {
            const val = parseInt(document.getElementById("batchQuotaInput").value);
            if(!val || val < 1) return alert("Érvényes számot adj meg!");
            if(!confirm(`Biztosan beállítod MINDEN felhasználónak a(z) ${val} napos keretet?`)) return;
            users.forEach(u => u.quota = val);
            if(window.pushData) window.pushData(); renderSettings(); alert("Sikeres csoportos beállítás!");
        }

        function addNewUser() {
            const name = document.getElementById("newUserName").value;
            const login = document.getElementById("newUserLogin").value;
            const pass = document.getElementById("newUserPass").value;
            const role = document.getElementById("newUserRole").value;
            const quota = document.getElementById("newUserQuota").value || 20;
            const carried = document.getElementById("newUserCarried").value || 0;
            if(!name || !login || !pass) return alert("Minden mező kötelező!");
            users.push({ id: Date.now(), name, login, pass, role, balance: 0, quota: parseInt(quota), carriedOver: parseInt(carried) });
            document.getElementById("newUserName").value = "";
            document.getElementById("newUserLogin").value = "";
            document.getElementById("newUserPass").value = "";
            if(window.pushData) window.pushData(); renderSettings(); renderBatchSelect(); renderRoster();
        }
        function updateUser(idx, field, val) { 
            if(field === 'quota' || field === 'carriedOver') val = parseInt(val);
            users[idx][field] = val; 
            if(window.pushData) window.pushData(); 
            if(field === 'quota' || field === 'carriedOver') renderSettings(); else renderRoster(); 
        }
        function updateUserPass(idx, val) {
            if(val && val.trim() !== "") {
                users[idx].pass = val.trim();
                if(window.pushData) window.pushData();
                alert("Jelszó sikeresen módosítva!");
            }
        }
        function deleteUser(idx) { if(confirm("Törlés?")) { users.splice(idx, 1); if(window.pushData) window.pushData(); renderSettings(); renderRoster(); } }

        function loadConfigForPeriod() {
            const key = getKey();
            const c = configs[key] || { norma: null, holidays: [], workWeekends: [] };
            document.getElementById("configHolidays").value = c.holidays.join(", ");
            if(c.workWeekends) {
                const wwStr = c.workWeekends.map(w => {
                    if(typeof w === 'object') {
                        return w.swap ? `${w.day}=${w.swap}` : `${w.day}`;
                    }
                    return `${w}`; 
                }).join(", ");
                document.getElementById("configWorkWeekends").value = wwStr;
            } else {
                document.getElementById("configWorkWeekends").value = "";
            }
            if(c.norma) document.getElementById("configNorma").value = c.norma; else calculateNormaForUI(true);
        }
        function saveMonthConfig() {
            const key = getKey();
            const hol = document.getElementById("configHolidays").value.split(",").map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            const wwInput = document.getElementById("configWorkWeekends").value;
            const ww = wwInput.split(",").map(s => {
                s = s.trim();
                if(!s) return null;
                if(s.includes("=")) {
                    const p = s.split("=");
                    const d = parseInt(p[0]);
                    const sw = parseInt(p[1]);
                    return (!isNaN(d)) ? { day: d, swap: !isNaN(sw) ? sw : null } : null;
                } else {
                    const d = parseInt(s);
                    return (!isNaN(d)) ? { day: d, swap: null } : null;
                }
            }).filter(x => x !== null);
            configs[key] = { norma: parseInt(document.getElementById("configNorma").value), holidays: hol, workWeekends: ww };
            if(window.pushData) window.pushData(); renderRoster();
        }

        // --- STATS LOGIC ---
        function openAbsenceStats() {
            const y = parseInt(document.getElementById("selYear").value);
            const mIdx = parseInt(document.getElementById("selMonth").value);
            const mName = document.getElementById("selMonth").options[mIdx].text;
            const key = getKey();
            const monthData = db[key] || {};
            const daysInMonth = new Date(y, mIdx + 1, 0).getDate();

            document.getElementById("absenceStatsTitle").innerText = `${y}. ${mName} - Havi Távollét & Sport Statisztika`;
            const tbody = document.getElementById("absenceStatsBody");
            tbody.innerHTML = "";

            users.forEach(u => {
                if(u.role === "VIEWER") return;
                let countX = 0, countB = 0, countRSZ = 0, countTM = 0;
                let totalSportMins = 0;
                let weeklySport = {}; 
                let currentWeek = 1;
                
                for(let d=1; d<=daysInMonth; d++) {
                      let date = new Date(y, mIdx, d);
                      if(!weeklySport[currentWeek]) weeklySport[currentWeek] = 0;
                      const uData = monthData[u.id] || {};
                      const entry = uData[d];
                      if(entry) {
                         if(entry.type === 'X') countX++;
                         else if(entry.type === 'B') countB++;
                         else if(entry.type === 'RSZ') countRSZ++;
                         else if(entry.type === 'TM') countTM++;
                         if(entry.sport) {
                            const sm = parseInt(entry.sport);
                            totalSportMins += sm;
                            weeklySport[currentWeek] += sm;
                         }
                      }
                      if(date.getDay() === 0) currentWeek++;
                }

                let weekStr = "";
                Object.keys(weeklySport).forEach(w => {
                    const val = weeklySport[w];
                    if(val > 0) weekStr += `${w}.hét: ${val}p, `;
                });
                if(weekStr.endsWith(", ")) weekStr = weekStr.slice(0, -2);

                const totalAbsence = countX + countB + countRSZ + countTM;
                const hasSport = totalSportMins > 0;
                const hasAbsence = totalAbsence > 0;

                if(hasSport || hasAbsence) {
                    let sportDisplay = `<span class="text-muted">-</span>`;
                    if(hasSport) {
                        sportDisplay = `<strong class="text-primary fs-6">${totalSportMins} perc</strong><br><small class="text-muted" style="font-size:0.75em">${weekStr}</small>`;
                    }
                    tbody.innerHTML += `<tr>
                        <td class="text-start fw-bold">${u.name}</td>
                        <td>${countX > 0 ? countX : '<span class="text-muted">-</span>'}</td>
                        <td>${countB > 0 ? countB : '<span class="text-muted">-</span>'}</td>
                        <td>${countRSZ > 0 ? countRSZ : '<span class="text-muted">-</span>'}</td>
                        <td>${countTM > 0 ? countTM : '<span class="text-muted">-</span>'}</td>
                        <td class="align-middle">${sportDisplay}</td>
                        <td class="fw-bold text-danger align-middle">${totalAbsence} nap</td>
                    </tr>`;
                }
            });

            if(tbody.innerHTML === "") {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Ebben a hónapban még nincs rögzítve adat (Távollét vagy Sport).</td></tr>`;
            }
            new bootstrap.Modal(document.getElementById('absenceStatsModal')).show();
        }
    </script>
</body>
</html>
