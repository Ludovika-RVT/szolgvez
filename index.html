<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RVT Szolgálattervezet V6.7 - Presence & Security</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* FONT & BASIC SETUP */
        body { background-color: #f4f6f9; font-family: 'Verdana', sans-serif; font-size: 0.85rem; }
        
        /* HEADER DESIGN (Blue Theme) */
        .header-bg { 
            background-color: #0d47a1; 
            color: white; 
            padding: 10px 0; 
            border-bottom: 4px solid #42a5f5; 
        }
        
        /* ICON LOGO STYLE */
        .gun-icon { margin-right: 10px; vertical-align: middle; color: #fff; }
        .gun-icon-login { color: #0d47a1; margin-bottom: 15px; }

        /* ACTIVE USERS DISPLAY */
        .online-list { font-size: 0.75rem; color: #bbdefb; margin-top: 2px; }
        .online-dot { color: #00e676; font-size: 8px; vertical-align: middle; margin-right: 2px; }

        /* TABLE STYLES */
        .roster-table th, .roster-table td { 
            text-align: center; vertical-align: middle; padding: 4px 2px;
            white-space: nowrap; border: 1px solid #dee2e6; position: relative;
        }
        .roster-table th { background-color: #343a40; color: white; font-size: 0.75rem; }
        
        .clickable-header { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
        .clickable-header:hover { color: #ffc107; }

        .roster-cell { cursor: pointer; height: 35px; min-width: 45px; font-size: 0.75rem; }
        .roster-cell:hover { border: 2px solid #0d6efd; z-index: 10; }

        /* Note Indicator (Red triangle in corner) */
        .note-indicator {
            position: absolute; top: 0; right: 0;
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-top: 6px solid #dc3545;
        }

        /* HEADER COLORS */
        .th-sat { background-color: #d1e7dd !important; color: #0f5132 !important; } 
        .th-sun { background-color: #f8d7da !important; color: #842029 !important; } 
        .th-hol { background-color: #dc3545 !important; color: white !important; border-color: #b02a37; } 

        /* ENTRY COLORS */
        .cell-pn, .cell-pi { background-color: #e2e3e5; color: #6c757d; }
        .cell-x { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .cell-rsz { background-color: #e0cffc; color: #4a148c; font-weight: bold; } 
        .cell-b { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        .cell-tm { background-color: #d1e7dd; color: #0f5132; font-weight: bold; }
        
        /* Hour Summary Colors */
        .hour-under { background-color: #fff3cd; color: #856404; font-weight: bold; } 
        .hour-ok { background-color: #d1e7dd; color: #0f5132; font-weight: bold; } 
        .hour-over { background-color: #f8d7da; color: #842029; font-weight: bold; } 

        /* SPORT TEXT COLOR */
        .text-sport { color: #6610f2; font-weight: bold; font-size: 0.8em; display: block; margin-top: 2px; }

        .name-col { 
            text-align: left !important; padding-left: 8px !important; font-weight: bold; 
            position: sticky; left: 0; background: white; z-index: 5; min-width: 150px; 
            border-right: 2px solid #ccc; cursor: pointer; color: #0d6efd;
        }
        .name-col:hover { text-decoration: underline; background-color: #f8f9fa; }

        /* LOGIN SCREEN & OVERLAYS */
        #loginOverlay, #loadingOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(13, 71, 161, 0.98); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            flex-direction: column; color: white;
        }
        .login-box { background: white; padding: 40px; border-radius: 8px; width: 450px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: #333; }
        
        /* CLOUD STATUS */
        .cloud-status { position: fixed; top: 10px; right: 10px; z-index: 10001; font-size: 12px; color: #ccc; }
        .cloud-ok { color: #2ecc71; }
        .cloud-sync { color: #f1c40f; }
        .cloud-error { color: #e74c3c; }

        /* PRINT SETTINGS (A3 Landscape - Scaled Down) */
        #printHeader, #printFooter { display: none; }
        .print-hidden-row { display: none !important; } 
        .hidden-perm { display: none !important; }

        @media print {
            @page { size: A3 landscape; margin: 5mm; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                zoom: 65%; /* SKÁLÁZÁS A LAPHOZ */
                font-family: 'Verdana', sans-serif; 
            }
            #mainApp > .header-bg, #loginOverlay, #loadingOverlay, .cloud-status, .no-print, .nav-tabs, #alertPlace, .modal { display: none !important; }
            .tab-content > .tab-pane { display: none !important; }
            .tab-content > .active { display: block !important; }
            
            #printHeader { display: block; margin-bottom: 20px; text-align: center; }
            /* Styling for new print header structure */
            #printHeader h2 { font-size: 28px; font-weight: bold; margin: 0; text-transform: uppercase; }
            #printHeader h3 { font-size: 20px; margin: 5px 0 0 0; font-weight: normal; }
            
            /* Print Footer Styles */
            #printFooter { 
                display: flex !important; 
                justify-content: space-between; 
                align-items: flex-end;
                margin-top: 40px; 
                padding: 0 50px;
                font-size: 14px;
            }
            
            .card { border: none !important; box-shadow: none !important; }
            .roster-table { width: 100%; border-collapse: collapse; }
            .roster-table th, .roster-table td { border: 1px solid #000 !important; font-size: 10px !important; padding: 1px !important; height: 20px !important; }
            .name-col { min-width: 100px !important; color: black !important; text-decoration: none !important; }
            .th-sat, .th-sun, .th-hol, .cell-x, .cell-b, .cell-tm, .cell-rsz { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .note-indicator { display: none; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-light mb-3" role="status"></div>
        <h4>Kapcsolódás a Firebase-hez...</h4>
        <small class="text-white-50" id="loadingStatusText">Rendszer betöltése...</small>
    </div>

    <!-- Cloud Status Icon -->
    <div class="cloud-status" id="cloudStatusIcon" title="Adatbázis Státusz">
        <i class="fa-solid fa-circle"></i> <span id="cloudStatusText">Offline</span>
    </div>

    <input type="file" id="jsonImportInput" accept=".json" style="display:none" onchange="processBackupImport(this)">

    <div id="loginOverlay" style="display:none;">
        <div class="login-box">
            <i class="fa-solid fa-gun fa-4x gun-icon-login"></i>
            <h3 class="mb-4 text-primary fw-bold" style="font-family: 'Verdana', sans-serif;">RVT Szolgálattervezet</h3>
            
            <input type="text" class="form-control mb-2" id="loginUser" placeholder="Felhasználónév">
            <input type="password" class="form-control mb-3" id="loginPass" placeholder="Jelszó">
            <button class="btn btn-primary w-100 fw-bold" onclick="performLogin()">Belépés</button>
            <div class="mt-3 small text-muted">Cloud V6.7 - Presence & Security</div>
        </div>
    </div>

    <div id="mainApp" style="display:none;">
        <div class="header-bg no-print">
            <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-gun fa-2x gun-icon"></i>
                    <h4 class="m-0 fw-bold">RVT Szolgálattervezet</h4>
                    
                    <div class="d-flex align-items-center gap-2 ms-4">
                        <select id="selYear" class="form-select form-select-sm w-auto" onchange="changePeriod()"></select>
                        <select id="selMonth" class="form-select form-select-sm w-auto" onchange="changePeriod()">
                            <option value="0">Január</option><option value="1">Február</option><option value="2">Március</option>
                            <option value="3">Április</option><option value="4">Május</option><option value="5">Június</option>
                            <option value="6">Július</option><option value="7">Augusztus</option><option value="8">Szeptember</option>
                            <option value="9">Október</option><option value="10">November</option><option value="11">December</option>
                        </select>
                    </div>
                </div>
                <div class="text-end">
                    <span class="fw-bold d-block" id="userInfo"></span>
                    <div class="online-list" id="activeUsersList"><i class="fa-solid fa-spinner fa-spin"></i></div>
                    <button class="btn btn-sm btn-light text-primary fw-bold mt-1" onclick="performLogout()"><i class="fa-solid fa-power-off"></i> Kilépés</button>
                </div>
            </div>
        </div>

        <div class="container-fluid mt-3">
            <div id="alertPlace"></div>

            <ul class="nav nav-tabs mb-3 no-print" id="mainTab" role="tablist">
                <li class="nav-item"><button class="nav-link active fw-bold" data-bs-target="#tab-roster" data-bs-toggle="tab"><i class="fa-solid fa-table"></i> Vezénylés (Naptár)</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-primary fw-bold" data-bs-target="#tab-batch" data-bs-toggle="tab"><i class="fa-solid fa-layer-group"></i> Csoportos Rögzítés</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-danger fw-bold" data-bs-target="#tab-users" data-bs-toggle="tab"><i class="fa-solid fa-user-lock"></i> Jogosultságok & Szabadság</button></li>
                <li class="nav-item admin-only"><button class="nav-link text-secondary fw-bold" data-bs-target="#tab-settings" data-bs-toggle="tab"><i class="fa-solid fa-calendar-check"></i> Havi Beállítások</button></li>
            </ul>

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-roster">
                    <div id="printHeader">
                        <h2>RVT SZOLGÁLATVEZÉNYLÉS</h2>
                        <h3 id="printSubtitle"></h3>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2 no-print">
                        <div class="text-muted small align-self-end"><i class="fa-solid fa-info-circle"></i> A nevekre kattintva megnyitható a felhasználói profil.</div>
                        
                        <div class="btn-group">
                             <button class="btn btn-outline-danger btn-sm fw-bold me-2" onclick="openAbsenceStats()"><i class="fa-solid fa-list-check"></i> Havi Távollét & Sport</button>
                             <button class="btn btn-outline-success btn-sm fw-bold admin-only" onclick="exportBackup()"><i class="fa-solid fa-download"></i> Mentés (Backup)</button>
                             <button class="btn btn-outline-warning btn-sm fw-bold admin-only" onclick="document.getElementById('jsonImportInput').click()"><i class="fa-solid fa-upload"></i> Visszatöltés</button>
                             <button class="btn btn-dark btn-sm ms-2" onclick="openPrintModal()"><i class="fa-solid fa-print"></i> Nyomtatás...</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm roster-table mb-0" id="mainRosterTable">
                                    <thead id="rosterHead"></thead>
                                    <tbody id="rosterBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 small text-muted">
                        Jelmagyarázat: <b>PI</b>: Pihenőidő | <b>PN</b>: Pihenőnap | <b>X</b>: Szabadság | <b>RSZ</b>: Rendkívüli Szab. | <b>B</b>: Beteg | <b>TM</b>: Túlszolg. Megváltás
                    </div>

                    <!-- PRINT FOOTER (Signature) -->
                    <div id="printFooter">
                        <div style="text-align:left;">
                            Budapest, <span id="printDate"></span>
                        </div>
                        <div style="text-align:center; padding-bottom: 40px; font-weight: bold;">
                            Jóváhagyom:
                        </div>
                        <div style="text-align:center; width: 350px;">
                            <div style="border-bottom: 2px solid black; margin-bottom: 8px;">&nbsp;</div>
                            <strong style="font-size: 1.1em;">Dr. Fekete Csaba r. dandártábornok</strong><br>
                            rendőrségi főtanácsos, mesteroktató<br>
                            intézetvezető, tagozatparancsnok
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-batch">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white fw-bold">Csoportos / Több napos rögzítés</div>
                                <div class="card-body">
                                    <label class="form-label fw-bold">1. Kinek?</label>
                                    <select class="form-select mb-3" id="batchUserSelect"></select>
                                    
                                    <label class="form-label fw-bold">2. Mettől - Meddig?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-6"><input type="number" class="form-control" id="batchStartDay" placeholder="Kezdő nap (pl. 1)" min="1" max="31"></div>
                                        <div class="col-6"><input type="number" class="form-control" id="batchEndDay" placeholder="Vég nap (pl. 5)" min="1" max="31"></div>
                                    </div>

                                    <label class="form-label fw-bold">3. Mit?</label>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <select class="form-select" id="batchType" onchange="toggleBatchTime()">
                                                <option value="WORK">Szolgálat</option>
                                                <option value="X">Szabadság (X)</option>
                                                <option value="RSZ">Rendkívüli Szab. (RSZ)</option>
                                                <option value="B">Beteg (B)</option>
                                                <option value="PI">Pihenőidő (PI)</option>
                                                <option value="PN">Pihenőnap (PN)</option>
                                                <option value="TM">Megváltás (TM)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8" id="batchTimeInputs">
                                            <div class="input-group">
                                                <span class="input-group-text">Idő</span>
                                                <input type="time" class="form-control" id="batchStartTime" value="07:00">
                                                <span class="input-group-text">-</span>
                                                <input type="time" class="form-control" id="batchEndTime" value="15:30">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100 fw-bold" onclick="applyBatch()">RÖGZÍTÉS VÉGREHAJTÁSA</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-users">
                     <div class="card border-danger">
                        <div class="card-header bg-danger text-white fw-bold d-flex justify-content-between">
                            <span>Felhasználók & Szabadság Keret</span>
                            <span class="badge bg-white text-danger" id="currentAdminYearDisplay"></span>
                        </div>
                        <div class="card-body">
                            <!-- New User Form -->
                            <div class="row g-2 mb-4 align-items-end border-bottom pb-4">
                                <div class="col-md-3">
                                    <label class="small text-muted">Teljes Név</label>
                                    <input type="text" class="form-control" id="newUserName" placeholder="pl. Minta János">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Login Név</label>
                                    <input type="text" class="form-control" id="newUserLogin" placeholder="pl. janos">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Jelszó</label>
                                    <input type="text" class="form-control" id="newUserPass" placeholder="******">
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Jogosultság</label>
                                    <select class="form-select" id="newUserRole">
                                        <option value="USER">User</option>
                                        <option value="VIEWER">Betekintő</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="small text-muted">Keret (Idei + Tavalyi)</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="newUserQuota" value="20" placeholder="Idén">
                                        <input type="number" class="form-control" id="newUserCarried" value="0" placeholder="Tavaly">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button class="btn btn-success w-100" onclick="addNewUser()" title="Új felhasználó"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>

                            <!-- Batch Quota Tool -->
                            <div class="alert alert-secondary d-flex align-items-center justify-content-between py-2">
                                <div><i class="fa-solid fa-users-gear"></i> <b>Csoportos Beállítás:</b> Minden felhasználó éves szabadság keretének beállítása:</div>
                                <div class="input-group w-auto">
                                    <input type="number" class="form-control form-control-sm" id="batchQuotaInput" value="25" style="width: 70px;">
                                    <button class="btn btn-sm btn-dark" onclick="setAllUserQuota()">Mindenkinek Beállít</button>
                                </div>
                            </div>
                            
                            <h5 class="mb-3">Regisztrált Felhasználók</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Név</th>
                                            <th>Login</th>
                                            <th style="width: 150px;">Jelszó (Rejtett)</th>
                                            <th>Jogkör</th>
                                            <th>Szabadság (Idei + Tavalyi / Kivett)</th>
                                            <th>Művelet</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userSettingsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-settings">
                     <div class="card h-100 border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">Havi Beállítások (Norma & Ünnepek)</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Havi Norma (Óra) - Auto számolt:</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="configNorma">
                                            <button class="btn btn-outline-secondary" onclick="calculateNormaForUI()" title="Újraszámolás"><i class="fa-solid fa-rotate-right"></i></button>
                                        </div>
                                        <small class="text-muted">Számítás: (Napok - Hétvége - Ünnep + Ledolgozós) * 8.</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-danger">Ünnepnapok (Piros):</label>
                                        <input type="text" class="form-control" id="configHolidays" placeholder="pl. 1, 15, 23" onchange="calculateNormaForUI()">
                                        <small class="text-muted">Vesszővel elválasztva.</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-success">Ledolgozós Hétvégék / Áthelyezés:</label>
                                        <input type="text" class="form-control" id="configWorkWeekends" placeholder="pl. 13=24 (13 dolgozós, 24 pihenő), 7 (sima túlóra)" onchange="calculateNormaForUI()">
                                        <small class="text-muted">Formátum: <b>X=Y</b> (X munkanap Y helyett) vagy csak <b>X</b> (extra munkanap).</small>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning w-100 fw-bold" onclick="saveMonthConfig()">Beállítások Mentése</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals (Edit, Batch, Print, Profile, Sport Stats, Absence Stats) -->
    
    <!-- EDIT MODAL -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="editModalTitle">Napi Beosztás Szerkesztése</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId"><input type="hidden" id="editDay">
                    
                    <div id="editModalContent">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Státusz:</label>
                            <div class="row g-1">
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stWork" value="WORK" checked onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stWork">Szolgálat</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPI" value="PI" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stPI">Pihenőidő</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stPN" value="PN" onchange="toggleModalFields()"><label class="btn btn-outline-secondary w-100 btn-sm" for="stPN">Pihenőnap</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stX" value="X" onchange="toggleModalFields()"><label class="btn btn-outline-warning text-dark w-100 btn-sm" for="stX">Szabadság</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stRSZ" value="RSZ" onchange="toggleModalFields()"><label class="btn btn-outline-dark w-100 btn-sm" style="background-color:#e0cffc; border-color:#9575cd;" for="stRSZ">Rendkívüli</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stB" value="B" onchange="toggleModalFields()"><label class="btn btn-outline-danger w-100 btn-sm" for="stB">Beteg</label></div>
                                <div class="col-4"><input type="radio" class="btn-check" name="sType" id="stTM" value="TM" onchange="toggleModalFields()"><label class="btn btn-outline-success w-100 btn-sm" for="stTM">TM</label></div>
                            </div>
                        </div>

                        <div id="timeFields">
                            <div class="row g-2 mb-2">
                                <div class="col-6"><label>Kezdés:</label><input type="time" class="form-control" id="startTime" onchange="calcHours()"></div>
                                <div class="col-6"><label>Vége:</label><input type="time" class="form-control" id="endTime" onchange="calcHours()"></div>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label>Számolt Óra:</label><input type="number" class="form-control" id="calcHours" step="0.5"></div>
                            <div class="col-6"><label class="text-primary">Túlszolgálat (+):</label><input type="number" class="form-control border-primary" id="overtimeVal" step="0.5"></div>
                        </div>

                        <!-- SPORT FIELD -->
                        <div class="mb-3 bg-light p-2 border rounded">
                            <label class="form-label fw-bold text-primary"><i class="fa-solid fa-dumbbell"></i> Sportfoglalkozás (perc):</label>
                            <input type="number" class="form-control" id="sportTime" placeholder="Pl. 60" min="0">
                            <small class="text-muted d-block mt-1">Heti limit: 120 perc.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label text-muted small">Megjegyzés / Indoklás:</label>
                            <textarea class="form-control" id="dayNote" rows="2" placeholder="Pl. túlszolgálat oka, vagy rendkívüli szabadság indoka..."></textarea>
                        </div>
                    </div>

                    <div id="editButtons">
                        <button class="btn btn-success w-100 fw-bold" onclick="saveEntry()">MENTÉS</button>
                        <button class="btn btn-outline-danger w-100 mt-2" onclick="deleteEntry()">Törlés</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BATCH MODAL -->
    <div class="modal fade" id="colBatchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Napi Csoportos Rögzítés (<span id="colBatchDayDisplay"></span>)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="colBatchDay">
                    <p class="small text-muted">Ez a beállítás <b>MINDENKIRE</b> érvényes lesz ezen a napon!</p>
                    <label class="fw-bold mb-2">Mit rögzítsünk mindenkinek?</label>
                    <div class="row g-2 mb-3">
                        <div class="col-md-5">
                            <select class="form-select" id="colBatchType" onchange="toggleColBatchTime()">
                                <option value="WORK">Szolgálat</option>
                                <option value="X">Szabadság</option>
                                <option value="RSZ">Rendkívüli Szab.</option>
                                <option value="PN">Pihenőnap</option>
                                <option value="PI">Pihenőidő</option>
                                <option value="TM">Megváltás</option>
                            </select>
                        </div>
                        <div class="col-md-7" id="colBatchTimeDiv">
                             <div class="input-group">
                                <input type="time" class="form-control" id="colBatchStart" value="07:00">
                                <span class="input-group-text">-</span>
                                <input type="time" class="form-control" id="colBatchEnd" value="15:30">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveColBatch()">MINDENKI FRISSÍTÉSE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT MODAL -->
    <div class="modal fade" id="printModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Nyomtatás kiválasztása</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Kik szerepeljenek a nyomtatáson?</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllPrint(true)">Összes</button>
                    </div>
                    <div class="list-group" id="printUserList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="executePrint()">NYOMTATÁS (A3 Fekvő)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- USER PROFILE MODAL -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-user"></i> Felhasználói Profil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="profileUserId">
                    <h4 id="profileName" class="mb-1 fw-bold text-center text-primary"></h4>
                    <p id="profileLogin" class="text-center text-muted small mb-4"></p>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body">
                            <h6 class="fw-bold">Éves Szabadság Statisztika (<span id="profileYear"></span>)</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Felhasznált / Keret (Idei+Tavalyi):</span>
                                <span class="fs-5 fw-bold" id="profileLeaveStats"></span>
                            </div>
                            <div class="text-center small text-muted mb-2" id="profileLeaveBreakdown"></div>
                            
                            <div class="progress mt-2" style="height: 10px;">
                                <div class="progress-bar bg-warning" id="profileLeaveProgress" style="width: 0%"></div>
                            </div>
                            <small id="leaveWarning" class="text-danger fw-bold mt-1 d-block" style="display:none;"></small>
                        </div>
                    </div>

                    <!-- ADMIN QUOTA EDIT -->
                    <div id="adminProfilePanel" style="display:none;" class="mb-3 border-top pt-3">
                        <h6 class="fw-bold text-danger"><i class="fa-solid fa-gear"></i> Admin Beállítások</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="small text-muted">Idei Keret:</label>
                                <input type="number" id="profileQuotaInput" class="form-control border-danger" placeholder="Pl. 25">
                            </div>
                            <div class="col-6">
                                <label class="small text-muted">Tavalyról Áthozott:</label>
                                <input type="number" id="profileCarriedInput" class="form-control border-danger" placeholder="Pl. 5">
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="fw-bold mb-3">Jelszó Módosítás</h6>
                    <div id="oldPassDiv" class="mb-2">
                        <label class="small">Régi Jelszó</label>
                        <input type="password" id="profileOldPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="small">Új Jelszó</label>
                        <input type="password" id="profileNewPass" class="form-control">
                    </div>
                    
                    <div id="adminOverrideDiv" class="alert alert-warning small py-1" style="display:none;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Admin módban a régi jelszó nem szükséges.
                    </div>

                    <button class="btn btn-info text-white w-100 fw-bold" onclick="saveProfileChanges()">Változtatások Mentése</button>
                    <div class="text-center mt-2">
                        <small class="text-muted" id="profileMessage"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ABSENCE & SPORT STATS MODAL (MERGED) -->
    <div class="modal fade" id="absenceStatsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-list-check"></i> Havi Távollét & Sport Statisztika</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-center fw-bold mb-3" id="absenceStatsTitle"></h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-hover text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-start">Név</th>
                                    <th>Szabadság (X)</th>
                                    <th>Beteg (B)</th>
                                    <th>Rendkívüli (RSZ)</th>
                                    <th>TM</th>
                                    <th style="min-width: 250px;">Sport (Havi / Heti)</th>
                                    <th>Összesen Távollét</th>
                                </tr>
                            </thead>
                            <tbody id="absenceStatsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG (Felhasználó által megadott)
        const firebaseConfig = {
            apiKey: "AIzaSyC25gpixaqD9eFf_y5ANXpaPQBjovS1MM8",
            authDomain: "szolgvez-46865.firebaseapp.com",
            projectId: "szolgvez-46865",
            storageBucket: "szolgvez-46865.firebasestorage.app",
            messagingSenderId: "559975823630",
            appId: "1:559975823630:web:a07f4bce53279e3f75bf5f"
        };

        let app, fsDB; // fsDB = Firestore DB (ne keverjük a db változóval ami a rostert tárolja)
        let dataReady = false;

        try {
            app = initializeApp(firebaseConfig);
            fsDB = getFirestore(app);
            console.log("Firebase Connected");
        } catch(e) {
            console.error("Firebase Connect Error:", e);
            document.getElementById("loadingStatusText").innerText = "Hiba: " + e.message;
        }

        // INIT SYNC
        function initFirebaseSync() {
            if(!fsDB) return;
            const statusIcon = document.getElementById("cloudStatusIcon");
            const statusText = document.getElementById("cloudStatusText");

            statusIcon.className = "cloud-status cloud-sync";
            statusText.innerText = "Sync...";

            // 1. USERS
            onSnapshot(doc(fsDB, "rvt_data", "users"), (snap) => {
                if(snap.exists()) {
                    window.users = snap.data().list || [];
                    checkReady();
                } else {
                    initializeDefaultDB(); // First run
                }
            });

            // 2. ROSTER (db)
            onSnapshot(doc(fsDB, "rvt_data", "roster"), (snap) => {
                if(snap.exists()) {
                    window.db = snap.data().data || {};
                    checkReady();
                }
            });

            // 3. CONFIGS
            onSnapshot(doc(fsDB, "rvt_data", "configs"), (snap) => {
                if(snap.exists()) {
                    window.configs = snap.data().data || {};
                    checkReady();
                }
            });

             // 4. PRESENCE (Ki van belépve?)
             onSnapshot(doc(fsDB, "rvt_data", "presence"), (snap) => {
                if(snap.exists()) {
                    renderPresence(snap.data());
                }
            });

            function checkReady() {
                if(!dataReady) {
                    document.getElementById("loadingOverlay").style.display = "none";
                    document.getElementById("loginOverlay").style.display = "flex";
                    dataReady = true;
                }
                statusIcon.className = "cloud-status cloud-ok";
                statusText.innerText = "Online";

                // Ha be van lépve, frissítsük a nézetet élőben
                if(window.currentUser) {
                    // Update current user ref from live data (balance, pass change etc)
                    const liveUser = window.users.find(u => u.id === window.currentUser.id);
                    if(liveUser) window.currentUser = liveUser;

                    window.changePeriod();
                    window.renderSettings();
                    window.renderBatchSelect();
                }
            }
        }

        // SAVE FUNCTIONS (Global overrides)
        window.pushData = async function() {
            if(!fsDB) return;
            document.getElementById("cloudStatusText").innerText = "Mentés...";
            try {
                // Egyszerűség kedvéért mindhárom kollekciót frissítjük
                await setDoc(doc(fsDB, "rvt_data", "users"), { list: window.users }, { merge: true });
                await setDoc(doc(fsDB, "rvt_data", "roster"), { data: window.db }, { merge: true });
                await setDoc(doc(fsDB, "rvt_data", "configs"), { data: window.configs }, { merge: true });
                
                document.getElementById("cloudStatusText").innerText = "Online";
                console.log("Saved to cloud");
            } catch(e) {
                console.error("Save Error", e);
                document.getElementById("cloudStatusText").innerText = "Hiba!";
                alert("Mentési hiba: " + e.message);
            }
        }

        // Presence Heartbeat
        window.sendHeartbeat = function() {
            if(!fsDB || !window.currentUser) return;
            const uid = window.currentUser.id;
            const name = window.currentUser.name;
            const timestamp = Date.now();
            setDoc(doc(fsDB, "rvt_data", "presence"), { [uid]: { name: name, time: timestamp } }, { merge: true });
        }

        async function initializeDefaultDB() {
            console.log("First run init...");
            // Default user
            const defUsers = [{ id: 1, name: "Admin", login: "admin", pass: "1234", role: "ADMIN", balance: 0, quota: 25, carriedOver: 0 }];
            
            await setDoc(doc(fsDB, "rvt_data", "users"), { list: defUsers });
            await setDoc(doc(fsDB, "rvt_data", "roster"), { data: {} });
            await setDoc(doc(fsDB, "rvt_data", "configs"), { data: {} });
            await setDoc(doc(fsDB, "rvt_data", "presence"), {});
            console.log("Defaults created.");
        }

        initFirebaseSync();
    </script>

    <!-- APP LOGIC -->
    <script>
        // --- DATA & STATE ---
        var users = [];
        var db = {}; 
        var configs = {}; 
        var currentUser = null;
        var heartbeatInterval = null;

        // --- INIT ---
        window.onload = function() {
            const y = new Date().getFullYear();
            const sY = document.getElementById("selYear");
            sY.innerHTML = "";
            for(let i=2023; i<=2030; i++) sY.innerHTML += `<option value="${i}" ${i===y?'selected':''}>${i}</option>`;
            document.getElementById("selMonth").value = new Date().getMonth();
        }

        // --- LOGIN & PERMISSIONS ---
        function applyPermissions() {
            const isAdmin = currentUser && currentUser.role === "ADMIN";
            const isViewer = currentUser && currentUser.role === "VIEWER";
            
            // Hide/Show Admin-only Tabs and Elements
            // Viewers also can't see Admin tabs (same logic as basic users)
            document.querySelectorAll(".admin-only").forEach(el => {
                el.classList.toggle("hidden-perm", !isAdmin);
            });
            
            // Clickable headers for batch edit (Admin only)
            document.querySelectorAll(".clickable-header").forEach(el => {
                el.style.pointerEvents = isAdmin ? "auto" : "none";
                el.title = isAdmin ? "Kattints csoportos rögzítéshez!" : "";
            });
        }

        function performLogin() {
            const u = document.getElementById("loginUser").value;
            const p = document.getElementById("loginPass").value;
            let found = users.find(x => x.login === u && x.pass === p);
            
            if(found) {
                currentUser = found;
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("mainApp").style.display = "block";
                document.getElementById("userInfo").innerText = `Belépve: ${currentUser.name} (${currentUser.role})`;
                
                // Start Presence Heartbeat
                window.sendHeartbeat();
                heartbeatInterval = setInterval(window.sendHeartbeat, 60000); // Every minute

                changePeriod(); 
                renderSettings();
                renderBatchSelect();
                applyPermissions();
            } else alert("Hibás felhasználónév vagy jelszó!");
        }

        function performLogout() { 
            if(confirm("Biztosan ki szeretne lépni?")) {
                if(heartbeatInterval) clearInterval(heartbeatInterval);
                location.reload(); 
            }
        }

        function renderPresence(presenceData) {
            const container = document.getElementById("activeUsersList");
            if(!presenceData) return;
            const now = Date.now();
            let activeNames = [];

            Object.keys(presenceData).forEach(uid => {
                const p = presenceData[uid];
                // 5 minute threshold
                if (now - p.time < 5 * 60 * 1000) {
                    activeNames.push(p.name);
                }
            });

            if(activeNames.length > 0) {
                container.innerHTML = `<span class="online-dot"><i class="fa-solid fa-circle"></i></span> Jelenleg Online: ` + activeNames.join(", ");
            } else {
                container.innerHTML = "";
            }
        }


        // --- BACKUP (JSON) ---
        function exportBackup() {
            if(currentUser.role !== "ADMIN") return alert("Ehhez csak Adminnak van jogosultsága!");
            const backupData = { timestamp: new Date().toISOString(), version: "6.7-PresenceSecurity", users: users, db: db, configs: configs };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `rvt_cloud_mentes_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function processBackupImport(input) {
            if(currentUser.role !== "ADMIN") return alert("Ehhez csak Adminnak van jogosultsága!");
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.users && importedData.db) {
                        if(confirm("FIGYELEM! A betöltés felülírja a felhőben lévő adatokat. Folytatod?")) {
                            users = importedData.users;
                            db = importedData.db;
                            configs = importedData.configs || {};
                            saveData(); // Pushes to cloud
                            alert("Sikeres visszatöltés! Az adatok szinkronizálva.");
                        }
                    } else alert("Hibás fájlstruktúra!");
                } catch(err) { console.error(err); alert("Hiba: " + err.message); }
                input.value = "";
            };
            reader.readAsText(file);
        }

        // --- CORE LOGIC ---
        function changePeriod() {
            calculateNormaForUI(true);
            loadConfigForPeriod();
            renderRoster();
            applyPermissions(); 
            // Also refresh settings if tab is open to show correct stats for year
            if(document.getElementById("tab-users").classList.contains("active")) renderSettings();
        }

        function getKey() {
            const y = document.getElementById("selYear").value;
            const m = parseInt(document.getElementById("selMonth").value) + 1;
            return `${y}-${m}`;
        }

        function calculateNorma(y, m, holidays, workWeekends) {
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            let workDays = 0;
            const swapOnDays = workWeekends.map(w => w.day);
            const swapOffDays = workWeekends.map(w => w.swap).filter(x => x);

            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(y, m, d);
                const dayOfWeek = date.getDay(); 
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                const isHoliday = holidays.includes(d);
                if (isHoliday) continue; 
                if (swapOffDays.includes(d)) continue;
                if (swapOnDays.includes(d)) { workDays++; continue; }
                if (!isWeekend) workDays++;
            }
            return workDays * 8;
        }

        function calculateNormaForUI(isAuto = false) {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const holStr = document.getElementById("configHolidays").value;
            const holidays = holStr ? holStr.split(",").map(x=>parseInt(x.trim())).filter(x=>!isNaN(x)) : [];
            const wwStr = document.getElementById("configWorkWeekends").value;
            let workWeekends = [];
            if(wwStr) {
                workWeekends = wwStr.split(",").map(s => {
                    s = s.trim();
                    if(s.includes("=")) {
                        const parts = s.split("=");
                        return { day: parseInt(parts[0]), swap: parseInt(parts[1]) };
                    } else {
                        const val = parseInt(s);
                        return !isNaN(val) ? { day: val, swap: null } : null;
                    }
                }).filter(x => x && !isNaN(x.day));
            }
            document.getElementById("configNorma").value = calculateNorma(y, m, holidays, workWeekends);
        }

        function renderRoster() {
            const y = parseInt(document.getElementById("selYear").value);
            const m = parseInt(document.getElementById("selMonth").value);
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const key = getKey();
            const monthData = db[key] || {};
            const conf = configs[key] || { norma: 168, holidays: [], workWeekends: [] };

            const thead = document.getElementById("rosterHead");
            const tbody = document.getElementById("rosterBody");
            
            const dayNames = ['V','H','K','S','C','P','S'];
            let hRow = `<tr><th style="min-width:150px; background:white;">Név:</th>`;
            
            let swapOnDays = [];
            if(conf.workWeekends && conf.workWeekends.length > 0) {
                 if(typeof conf.workWeekends[0] === 'object') {
                     swapOnDays = conf.workWeekends.map(w => w.day);
                 } else {
                     swapOnDays = conf.workWeekends;
                 }
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(y, m, i);
                const dayOfWeek = date.getDay();
                let thClass = "";
                if (conf.holidays.includes(i)) thClass = "th-hol";
                else if (dayOfWeek === 6 && !swapOnDays.includes(i)) thClass = "th-sat";
                else if (dayOfWeek === 0 && !swapOnDays.includes(i)) thClass = "th-sun";
                hRow += `<th class="${thClass} clickable-header" onclick="openColumnBatch(${i})">${i}.<br>${dayNames[dayOfWeek]}</th>`;
            }
            hRow += `<th style="min-width:80px">Norma / Telj.</th><th style="min-width:60px">Túlsz.</th></tr>`;
            thead.innerHTML = hRow;
            
            const monthName = document.getElementById("selMonth").options[m].text;
            document.getElementById("printSubtitle").innerText = `${y}. ${monthName}`;

            tbody.innerHTML = "";
            users.forEach(u => {
                // Filter out Viewer from the Roster view
                if(u.role === "VIEWER") return;

                let rowHtml = `<tr data-uid="${u.id}"><td class="name-col" onclick="openUserProfile(${u.id})">${u.name}</td>`;
                let totalHours = 0, monthOvertime = 0;
                const uData = monthData[u.id] || {};

                for (let i = 1; i <= daysInMonth; i++) {
                    const entry = uData[i];
                    let content = "", cls = "", noteIndicator="";
                    if (entry) {
                        if(entry.note && entry.note.trim() !== "") {
                            noteIndicator = `<div class="note-indicator" title="${entry.note}"></div>`;
                        }

                        if (entry.type === "WORK") {
                            content = `${entry.start}-${entry.end}`;
                            if(entry.overtime > 0) content += `<br><span class="text-danger fw-bold">+${entry.overtime}</span>`;
                            totalHours += parseFloat(entry.hours);
                        } else if (entry.type === "TM") { content = "TM"; cls = "cell-tm"; }
                        else {
                            content = entry.type;
                            if(entry.type==="X") { cls="cell-x"; totalHours += parseFloat(entry.hours); }
                            if(entry.type==="RSZ") { cls="cell-rsz"; totalHours += parseFloat(entry.hours); } 
                            if(entry.type==="B") { cls="cell-b"; totalHours += parseFloat(entry.hours); }
                            if(entry.type==="PN"||entry.type==="PI") cls="cell-pn";
                        }
                        if(entry.overtime) monthOvertime += parseFloat(entry.overtime);
                        
                        if(entry.sport > 0) {
                            content += `<span class="text-sport"><i class="fa-solid fa-dumbbell"></i> ${entry.sport}p</span>`;
                        }
                    }
                    rowHtml += `<td class="roster-cell ${cls}" onclick="openEdit(${u.id}, ${i})">${content}${noteIndicator}</td>`;
                }
                const norma = parseInt(conf.norma);
                let hourClass = totalHours < norma ? "hour-under" : (totalHours > norma ? "hour-over" : "hour-ok");
                
                let currentMonthChange = monthOvertime;
                Object.values(uData).forEach(e => { if(e.type === "TM") currentMonthChange -= 8; });
                const finalBalance = (parseFloat(u.balance) || 0) + currentMonthChange;
                const balCol = finalBalance < 0 ? "text-danger" : "text-success";

                rowHtml += `<td class="${hourClass}">${norma} / ${totalHours}</td><td class="${balCol} fw-bold">${finalBalance}</td></tr>`;
                tbody.innerHTML += rowHtml;
            });
        }

        // --- EDIT LOGIC ---
        function openEdit(uId, day) {
            // VIEWER MODIFICATION: Allow Viewers to open, but strictly readonly.
            const isViewer = currentUser.role === "VIEWER";

            const key = getKey();
            const existing = db[key]?.[uId]?.[day];

            // Access Control Logic
            if (!isViewer && currentUser.role !== "ADMIN") {
                if (uId !== currentUser.id) {
                    alert("Csak a saját sorodat szerkesztheted!"); return;
                }
                if (existing && existing.type !== 'PI' && existing.type !== 'PN' && !existing.start) {
                    alert("Már van rögzített beosztás, csak az Admin módosíthatja!"); return;
                }
            }

            document.getElementById("editUserId").value = uId;
            document.getElementById("editDay").value = day;
            document.getElementById("sportTime").value = ""; 

            if (existing) {
                const rType = document.querySelector(`input[name="sType"][value="${existing.type}"]`);
                if(rType) rType.checked = true; else document.getElementById("stWork").checked = true;

                if(existing.type==="WORK") {
                    document.getElementById("startTime").value = existing.start;
                    document.getElementById("endTime").value = existing.end;
                    document.getElementById("calcHours").value = existing.hours;
                    document.getElementById("overtimeVal").value = existing.overtime || 0;
                } else {
                    document.getElementById("calcHours").value = existing.hours;
                    document.getElementById("overtimeVal").value = 0;
                }
                document.getElementById("dayNote").value = existing.note || "";
                document.getElementById("sportTime").value = existing.sport || "";
            } else {
                document.getElementById("stWork").checked = true;
                document.getElementById("startTime").value = "07:00";
                document.getElementById("endTime").value = "15:30";
                document.getElementById("dayNote").value = "";
                calcHours();
            }
            toggleModalFields();
            
            // VIEWER UI ADJUSTMENTS
            const modalTitle = document.getElementById("editModalTitle");
            const btnContainer = document.getElementById("editButtons");
            const inputs = document.querySelectorAll("#editModalContent input, #editModalContent textarea");

            if(isViewer) {
                modalTitle.innerText = "Részletek Megtekintése (Csak Olvasható)";
                modalTitle.className = "modal-title text-secondary fw-bold";
                btnContainer.style.display = "none";
                inputs.forEach(el => el.disabled = true);
            } else {
                modalTitle.innerText = "Napi Beosztás Szerkesztése";
                modalTitle.className = "modal-title";
                btnContainer.style.display = "block";
                inputs.forEach(el => el.disabled = false);
                toggleModalFields(); // Re-run to handle enable/disable logic based on radio
            }

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function toggleModalFields() {
            // Re-check readonly status for Viewer to prevent re-enabling
            if(currentUser.role === "VIEWER") return; 

            const t = document.querySelector('input[name="sType"]:checked').value;
            const tf = document.getElementById("timeFields");
            const ov = document.getElementById("overtimeVal");
            
            if(t === "B" || t === "TM") { ov.value = 0; ov.disabled = true; } else { ov.disabled = false; }
            if(t==="WORK") { tf.style.display="block"; calcHours(); } 
            else { 
                tf.style.display="none"; 
                document.getElementById("calcHours").value = (t==="X"||t==="B"||t==="RSZ") ? 8 : 0; 
                if(t!=="WORK") ov.value = 0;
            }
        }

        function calcHours() {
            if(!document.getElementById("stWork").checked) return;
            const s = document.getElementById("startTime").value;
            const e = document.getElementById("endTime").value;
            document.getElementById("calcHours").value = calculateDiff(s, e);
        }
        function calculateDiff(s, e) {
            const sp = s.split(":"); const ep = e.split(":");
            let diff = (parseInt(ep[0])*60+parseInt(ep[1]) - (parseInt(sp[0])*60+parseInt(sp[1])))/60;
            if(diff < 0) diff += 24; return diff;
        }

        function getGlobalEntry(uId, year, month, day) {
            const k = `${year}-${month + 1}`;
            if(db[k] && db[k][uId] && db[k][uId][day]) {
                return db[k][uId][day];
            }
            return null;
        }

        function checkWeeklySportLimit(uId, currentYear, currentMonth, currentDay, newSportVal) {
            const date = new Date(currentYear, currentMonth, currentDay);
            const dayOfWeek = date.getDay(); 
            const distToMon = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
            const mondayDate = new Date(date);
            mondayDate.setDate(date.getDate() - distToMon);

            let weeklySum = 0;
            for(let i=0; i<7; i++) {
                const d = new Date(mondayDate);
                d.setDate(mondayDate.getDate() + i);
                if(d.getFullYear() === currentYear && d.getMonth() === currentMonth && d.getDate() === currentDay) {
                    weeklySum += newSportVal;
                } else {
                    const entry = getGlobalEntry(uId, d.getFullYear(), d.getMonth(), d.getDate());
                    if(entry && entry.sport) {
                        weeklySum += parseInt(entry.sport);
                    }
                }
            }
            return weeklySum;
        }

        function saveEntry() {
            if (currentUser.role === "VIEWER") return;

            const uId = document.getElementById("editUserId").value;
            const day = parseInt(document.getElementById("editDay").value);
            const key = getKey();
            
            const sportVal = parseInt(document.getElementById("sportTime").value) || 0;
            if(sportVal > 0) {
                const y = parseInt(document.getElementById("selYear").value);
                const m = parseInt(document.getElementById("selMonth").value);
                const weeklySum = checkWeeklySportLimit(uId, y, m, day, sportVal);
                
                if(weeklySum > 120) {
                    if(!confirm(`FIGYELEM!\nA heti sport limit (120 perc) túl lesz lépve!\n\nJelenlegi heti összesen (az új értékkel): ${weeklySum} perc.\n\nBiztosan rögzíted?`)) {
                        return; 
                    }
                }
            }

            if(!db[key]) db[key] = {}; if(!db[key][uId]) db[key][uId] = {};
            const type = document.querySelector('input[name="sType"]:checked').value;
            db[key][uId][day] = {
                type: type,
                start: type==="WORK"?document.getElementById("startTime").value:"",
                end: type==="WORK"?document.getElementById("endTime").value:"",
                hours: parseFloat(document.getElementById("calcHours").value)||0,
                overtime: parseFloat(document.getElementById("overtimeVal").value)||0,
                note: document.getElementById("dayNote").value.trim(),
                sport: sportVal 
            };
            saveData(); renderRoster();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }
        function deleteEntry() {
            if (currentUser.role === "VIEWER") return;

            const uId = document.getElementById("editUserId").value;
            if (currentUser.role !== "ADMIN" && uId != currentUser.id) return;
            if(currentUser.role !== "ADMIN") { alert("Törlést csak Admin végezhet."); return; }

            const day = document.getElementById("editDay").value;
            const key = getKey();
            if(db[key] && db[key][uId]) delete db[key][uId][day];
            saveData(); renderRoster();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        // --- ABSENCE & SPORT STATISTICS ---
        function openAbsenceStats() {
            const y = parseInt(document.getElementById("selYear").value);
            const mIdx = parseInt(document.getElementById("selMonth").value);
            const mName = document.getElementById("selMonth").options[mIdx].text;
            const key = getKey();
            const monthData = db[key] || {};
            const daysInMonth = new Date(y, mIdx + 1, 0).getDate();

            document.getElementById("absenceStatsTitle").innerText = `${y}. ${mName} - Havi Távollét & Sport Statisztika`;
            const tbody = document.getElementById("absenceStatsBody");
            tbody.innerHTML = "";

            users.forEach(u => {
                if(u.role === "VIEWER") return;

                let countX = 0, countB = 0, countRSZ = 0, countTM = 0;
                let totalSportMins = 0;
                let weeklySport = {}; 
                let currentWeek = 1;
                
                for(let d=1; d<=daysInMonth; d++) {
                     let date = new Date(y, mIdx, d);
                     if(!weeklySport[currentWeek]) weeklySport[currentWeek] = 0;
                     const uData = monthData[u.id] || {};
                     const entry = uData[d];
                     if(entry) {
                        if(entry.type === 'X') countX++;
                        else if(entry.type === 'B') countB++;
                        else if(entry.type === 'RSZ') countRSZ++;
                        else if(entry.type === 'TM') countTM++;
                        if(entry.sport) {
                            const sm = parseInt(entry.sport);
                            totalSportMins += sm;
                            weeklySport[currentWeek] += sm;
                        }
                     }
                     if(date.getDay() === 0) currentWeek++;
                }

                let weekStr = "";
                Object.keys(weeklySport).forEach(w => {
                    const val = weeklySport[w];
                    if(val > 0) weekStr += `${w}.hét: ${val}p, `;
                });
                if(weekStr.endsWith(", ")) weekStr = weekStr.slice(0, -2);

                const totalAbsence = countX + countB + countRSZ + countTM;
                const hasSport = totalSportMins > 0;
                const hasAbsence = totalAbsence > 0;

                if(hasSport || hasAbsence) {
                    let sportDisplay = `<span class="text-muted">-</span>`;
                    if(hasSport) {
                        sportDisplay = `<strong class="text-primary fs-6">${totalSportMins} perc</strong><br><small class="text-muted" style="font-size:0.75em">${weekStr}</small>`;
                    }
                    tbody.innerHTML += `<tr>
                        <td class="text-start fw-bold">${u.name}</td>
                        <td>${countX > 0 ? countX : '<span class="text-muted">-</span>'}</td>
                        <td>${countB > 0 ? countB : '<span class="text-muted">-</span>'}</td>
                        <td>${countRSZ > 0 ? countRSZ : '<span class="text-muted">-</span>'}</td>
                        <td>${countTM > 0 ? countTM : '<span class="text-muted">-</span>'}</td>
                        <td class="align-middle">${sportDisplay}</td>
                        <td class="fw-bold text-danger align-middle">${totalAbsence} nap</td>
                    </tr>`;
                }
            });

            if(tbody.innerHTML === "") {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Ebben a hónapban még nincs rögzítve adat (Távollét vagy Sport).</td></tr>`;
            }
            new bootstrap.Modal(document.getElementById('absenceStatsModal')).show();
        }

        // --- USER PROFILE & PASSWORD ---
        function openUserProfile(uId) {
            const u = users.find(x => x.id == uId);
            if(!u) return;

            document.getElementById("profileUserId").value = u.id;
            document.getElementById("profileName").innerText = u.name;
            document.getElementById("profileLogin").innerText = `Login: ${u.login} | Jogkör: ${u.role}`;
            document.getElementById("profileMessage").innerText = "";
            document.getElementById("profileOldPass").value = "";
            document.getElementById("profileNewPass").value = "";
            
            const isAdmin = currentUser.role === "ADMIN";
            const isSelf = currentUser.id == uId;
            
            const adminPanel = document.getElementById("adminProfilePanel");
            const quotaInput = document.getElementById("profileQuotaInput");
            const carriedInput = document.getElementById("profileCarriedInput");
            
            if (isAdmin) {
                adminPanel.style.display = "block";
                quotaInput.value = u.quota || 20;
                carriedInput.value = u.carriedOver || 0;
            } else {
                adminPanel.style.display = "none";
            }

            document.getElementById("oldPassDiv").style.display = (isAdmin && !isSelf) ? "none" : "block";
            document.getElementById("adminOverrideDiv").style.display = (isAdmin && !isSelf) ? "block" : "none";

            const y = parseInt(document.getElementById("selYear").value);
            document.getElementById("profileYear").innerText = y;
            const quota = parseInt(u.quota) || 20;
            const carried = parseInt(u.carriedOver) || 0;
            const totalAvailable = quota + carried;
            const used = calculateUsedLeave(u.id, y);
            
            document.getElementById("profileLeaveStats").innerText = `${used} / ${totalAvailable}`;
            document.getElementById("profileLeaveBreakdown").innerHTML = `Idei: <b>${quota}</b> + Áthozott: <b>${carried}</b> = Összesen: <b>${totalAvailable}</b>`;

            let pct = (used / totalAvailable) * 100;
            if(pct > 100) pct = 100;
            const bar = document.getElementById("profileLeaveProgress");
            bar.style.width = pct + "%";
            bar.className = (used > totalAvailable) ? "progress-bar bg-danger" : "progress-bar bg-success";
            
            const warn = document.getElementById("leaveWarning");
            if(used > totalAvailable) {
                warn.innerText = `FIGYELEM! A szabadság keret túllépve ${used - totalAvailable} nappal!`;
                warn.style.display = "block";
            } else {
                warn.style.display = "none";
            }
            new bootstrap.Modal(document.getElementById('userProfileModal')).show();
        }

        function calculateUsedLeave(uId, year) {
            let used = 0;
            for(let m=1; m<=12; m++) {
                const k = `${year}-${m}`;
                if(db[k] && db[k][uId]) {
                    Object.values(db[k][uId]).forEach(entry => {
                        if(entry.type === 'X') used++;
                    });
                }
            }
            return used;
        }

        function saveProfileChanges() {
            const uId = document.getElementById("profileUserId").value;
            const newPass = document.getElementById("profileNewPass").value.trim();
            const oldPass = document.getElementById("profileOldPass").value.trim();
            const msg = document.getElementById("profileMessage");
            const idx = users.findIndex(x => x.id == uId);
            if(idx === -1) return;

            let changesMade = false;
            if(currentUser.role === "ADMIN") {
                const newQuota = parseInt(document.getElementById("profileQuotaInput").value);
                const newCarried = parseInt(document.getElementById("profileCarriedInput").value);
                
                if(!isNaN(newQuota) && newQuota !== users[idx].quota) {
                    users[idx].quota = newQuota;
                    changesMade = true;
                }
                if(!isNaN(newCarried) && newCarried !== users[idx].carriedOver) {
                    users[idx].carriedOver = newCarried;
                    changesMade = true;
                }
            }

            if(newPass) {
                const isAdmin = currentUser.role === "ADMIN";
                const isSelf = currentUser.id == uId;
                
                if (currentUser.role === "VIEWER" && !isSelf) return;

                if(isAdmin && !isSelf) {
                    users[idx].pass = newPass;
                    changesMade = true;
                } else {
                    if(users[idx].pass === oldPass) {
                        users[idx].pass = newPass;
                        changesMade = true;
                    } else {
                        msg.className = "text-danger fw-bold";
                        msg.innerText = "Hiba: A régi jelszó nem megfelelő!";
                        return;
                    }
                }
            }

            if(changesMade) {
                saveData();
                msg.className = "text-success fw-bold";
                msg.innerText = "Sikeres mentés!";
                setTimeout(() => {
                    const u = users[idx];
                    const y = parseInt(document.getElementById("selYear").value);
                    const quota = parseInt(u.quota) || 20;
                    const carried = parseInt(u.carriedOver) || 0;
                    const total = quota + carried;
                    const used = calculateUsedLeave(u.id, y);
                    
                    document.getElementById("profileLeaveStats").innerText = `${used} / ${total}`;
                    document.getElementById("profileLeaveBreakdown").innerHTML = `Idei: <b>${quota}</b> + Áthozott: <b>${carried}</b> = Összesen: <b>${total}</b>`;
                    renderRoster();
                    if(document.getElementById("tab-users").classList.contains("active")) renderSettings();
                }, 500);
            } else {
                msg.innerText = "Nincs változás.";
            }
        }

        // --- BATCH & PRINT ---
        function openColumnBatch(day) {
             if(currentUser.role !== "ADMIN") return alert("Csak Admin rögzíthet csoportosan!");
             document.getElementById("colBatchDay").value = day;
             document.getElementById("colBatchDayDisplay").innerText = day + ". nap";
             new bootstrap.Modal(document.getElementById('colBatchModal')).show();
        }
        function toggleColBatchTime() {
             const t = document.getElementById("colBatchType").value;
             document.getElementById("colBatchTimeDiv").style.display = (t === "WORK") ? "block" : "none";
        }
        function saveColBatch() {
             const day = document.getElementById("colBatchDay").value;
             const type = document.getElementById("colBatchType").value;
             const key = getKey();
             if(!db[key]) db[key] = {};
             users.forEach(u => {
                 if(!db[key][u.id]) db[key][u.id] = {};
                 let entry = { type: type, hours: 0, start: "", end: "", overtime: 0, note: "" };
                 if(type === "WORK") {
                    entry.start = document.getElementById("colBatchStart").value;
                    entry.end = document.getElementById("colBatchEnd").value;
                    entry.hours = calculateDiff(entry.start, entry.end);
                 } else if (type === "X" || type === "B" || type === "RSZ") { entry.hours = 8; }
                 db[key][u.id][day] = entry;
             });
             saveData(); renderRoster();
             bootstrap.Modal.getInstance(document.getElementById('colBatchModal')).hide();
        }
        
        function openPrintModal() {
            const list = document.getElementById("printUserList"); list.innerHTML = "";
            users.forEach(u => { 
                if(u.role === "VIEWER") return;
                list.innerHTML += `<label class="list-group-item"><input class="form-check-input me-1 print-check" type="checkbox" value="${u.id}" checked>${u.name}</label>`; 
            });
            new bootstrap.Modal(document.getElementById('printModal')).show();
        }
        function toggleAllPrint(state) { document.querySelectorAll(".print-check").forEach(c => c.checked = true); }
        function executePrint() {
            const selectedIds = Array.from(document.querySelectorAll(".print-check:checked")).map(c => c.value);
            const rows = document.querySelectorAll("#mainRosterTable tbody tr");
            rows.forEach(r => {
                const uid = r.getAttribute("data-uid");
                if(selectedIds.includes(uid)) r.classList.remove("print-hidden-row"); else r.classList.add("print-hidden-row");
            });
            
            const today = new Date();
            const dateStr = `${today.getFullYear()}. ${today.toLocaleString('hu-HU', { month: 'long' })} ${today.getDate()}.`;
            document.getElementById('printDate').innerText = dateStr;

            bootstrap.Modal.getInstance(document.getElementById('printModal')).hide();
            setTimeout(() => { window.print(); setTimeout(() => { rows.forEach(r => r.classList.remove("print-hidden-row")); }, 1000); }, 500);
        }
        
        function renderBatchSelect() {
            const s = document.getElementById("batchUserSelect"); s.innerHTML = `<option value="ALL">-- MINDENKI --</option>`;
            users.forEach(u => {
                if(u.role === "VIEWER") return;
                s.innerHTML += `<option value="${u.id}">${u.name}</option>`;
            });
        }
        function toggleBatchTime() {
            const t = document.getElementById("batchType").value; document.getElementById("batchTimeInputs").style.display = (t === "WORK") ? "block" : "none";
        }
        function applyBatch() {
            const uId = document.getElementById("batchUserSelect").value;
            const startD = parseInt(document.getElementById("batchStartDay").value);
            const endD = parseInt(document.getElementById("batchEndDay").value);
            const type = document.getElementById("batchType").value;
            const key = getKey();
            if(!db[key]) db[key] = {};
            const targetUsers = (uId === "ALL") ? users : users.filter(u => u.id == uId);
            targetUsers.forEach(u => {
                if(!db[key][u.id]) db[key][u.id] = {};
                for(let i=startD; i<=endD; i++) {
                    let entry = { type: type, hours: 0, start: "", end: "", overtime: 0, note: "" };
                    if(type === "WORK") {
                        entry.start = document.getElementById("batchStartTime").value;
                        entry.end = document.getElementById("batchEndTime").value;
                        entry.hours = calculateDiff(entry.start, entry.end);
                    } else if(type === "X" || type === "B" || type === "RSZ") entry.hours = 8;
                    db[key][u.id][i] = entry;
                }
            });
            saveData(); renderRoster(); alert("Sikeres rögzítés!");
        }

        // --- SETTINGS (Users & Batch) ---
        function renderSettings() {
            const tb = document.getElementById("userSettingsTable"); tb.innerHTML = "";
            const currentYear = parseInt(document.getElementById("selYear").value);
            document.getElementById("currentAdminYearDisplay").innerText = `Adatok erre az évre: ${currentYear}`;

            users.forEach((u, idx) => {
                const q = u.quota || 20;
                const c = u.carriedOver || 0;
                const total = q + c;
                const used = calculateUsedLeave(u.id, currentYear);
                const warnClass = used > total ? "text-danger fw-bold" : "text-success";
                
                tb.innerHTML += `<tr>
                    <td><input type="text" class="form-control form-control-sm" value="${u.name}" onchange="updateUser(${idx},'name',this.value)"></td>
                    <td><input type="text" class="form-control form-control-sm" value="${u.login}" onchange="updateUser(${idx},'login',this.value)"></td>
                    <!-- PASSWORD FIELD MODIFIED FOR SECURITY -->
                    <td>
                        <input type="text" class="form-control form-control-sm border-warning" 
                               placeholder="Új jelszó..." 
                               onchange="updateUserPass(${idx}, this.value)" 
                               title="A régi jelszó rejtett. Írj be újat a cseréhez.">
                    </td>
                    <td><select class="form-select form-select-sm" onchange="updateUser(${idx},'role',this.value)">
                        <option value="USER" ${u.role==='USER'?'selected':''}>User</option>
                        <option value="VIEWER" ${u.role==='VIEWER'?'selected':''}>Betekintő</option>
                        <option value="ADMIN" ${u.role==='ADMIN'?'selected':''}>Admin</option>
                    </select></td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" style="width:50px" title="Idei Keret" value="${q}" onchange="updateUser(${idx},'quota',this.value)">
                            <span class="input-group-text">+</span>
                            <input type="number" class="form-control" style="width:50px" title="Áthozott (Tavalyi)" value="${c}" onchange="updateUser(${idx},'carriedOver',this.value)">
                            <span class="input-group-text ${warnClass}" style="min-width: 80px;">Kivett: ${used}</span>
                        </div>
                    </td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteUser(${idx})"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function setAllUserQuota() {
            const val = parseInt(document.getElementById("batchQuotaInput").value);
            if(!val || val < 1) return alert("Érvényes számot adj meg!");
            if(!confirm(`Biztosan beállítod MINDEN felhasználónak a(z) ${val} napos keretet?`)) return;
            
            users.forEach(u => u.quota = val);
            saveData();
            renderSettings();
            alert("Sikeres csoportos beállítás!");
        }

        function addNewUser() {
            const name = document.getElementById("newUserName").value;
            const login = document.getElementById("newUserLogin").value;
            const pass = document.getElementById("newUserPass").value;
            const role = document.getElementById("newUserRole").value;
            const quota = document.getElementById("newUserQuota").value || 20;
            const carried = document.getElementById("newUserCarried").value || 0;
            
            if(!name || !login || !pass) return alert("Minden mező kötelező!");
            users.push({ id: Date.now(), name, login, pass, role, balance: 0, quota: parseInt(quota), carriedOver: parseInt(carried) });
            
            document.getElementById("newUserName").value = "";
            document.getElementById("newUserLogin").value = "";
            document.getElementById("newUserPass").value = "";
            
            saveData(); renderSettings(); renderBatchSelect(); renderRoster();
        }
        function updateUser(idx, field, val) { 
            if(field === 'quota' || field === 'carriedOver') val = parseInt(val);
            users[idx][field] = val; 
            saveData(); 
            if(field === 'quota' || field === 'carriedOver') renderSettings();
            else renderRoster(); 
        }

        // New specific function for password update to avoid overwriting with empty
        function updateUserPass(idx, val) {
            if(val && val.trim() !== "") {
                users[idx].pass = val.trim();
                saveData();
                alert("Jelszó sikeresen módosítva!");
            }
        }

        function deleteUser(idx) { if(confirm("Törlés?")) { users.splice(idx, 1); saveData(); renderSettings(); renderRoster(); } }

        function loadConfigForPeriod() {
            const key = getKey();
            const c = configs[key] || { norma: null, holidays: [], workWeekends: [] };
            document.getElementById("configHolidays").value = c.holidays.join(", ");
            
            if(c.workWeekends) {
                const wwStr = c.workWeekends.map(w => {
                    if(typeof w === 'object') {
                        return w.swap ? `${w.day}=${w.swap}` : `${w.day}`;
                    }
                    return `${w}`; 
                }).join(", ");
                document.getElementById("configWorkWeekends").value = wwStr;
            } else {
                document.getElementById("configWorkWeekends").value = "";
            }

            if(c.norma) document.getElementById("configNorma").value = c.norma; else calculateNormaForUI(true);
        }
        function saveMonthConfig() {
            const key = getKey();
            const hol = document.getElementById("configHolidays").value.split(",").map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            
            const wwInput = document.getElementById("configWorkWeekends").value;
            const ww = wwInput.split(",").map(s => {
                s = s.trim();
                if(!s) return null;
                if(s.includes("=")) {
                    const p = s.split("=");
                    const d = parseInt(p[0]);
                    const sw = parseInt(p[1]);
                    return (!isNaN(d)) ? { day: d, swap: !isNaN(sw) ? sw : null } : null;
                } else {
                    const d = parseInt(s);
                    return (!isNaN(d)) ? { day: d, swap: null } : null;
                }
            }).filter(x => x !== null);

            configs[key] = { norma: parseInt(document.getElementById("configNorma").value), holidays: hol, workWeekends: ww };
            saveData(); renderRoster();
        }

        // --- IO (Firebase replaced localStorage) ---
        function saveData() { 
            if(window.pushData) window.pushData();
        }

    </script>
</body>
</html>
